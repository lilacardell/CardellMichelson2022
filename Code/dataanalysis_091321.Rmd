---
title: "Data Analysis"
author: "Lila Cardell"
date: "09/02/2021"
output: html_document
---


Load packages
```{r setup, echo=FALSE,warning=FALSE,message=FALSE,results='hide'}
knitr::opts_chunk$set(
	message = FALSE,
	warning = FALSE,
	include = FALSE,
	root.dir = "C:/Users/lilac2/Box/GIEWS_Project/GIEWS/R"
)
options(scipen=999,warn=-1)
set.seed(101484)
###  Check for and load Packages   ###
#writeLines('PATH="${RTOOLS40_HOME}\\usr\\bin;${PATH}"', con = "~/.Renviron")

## Clear worksace
rm(list = ls())
gc()

## This function will check if a package is installed, and if not, install it
pkgTest  =  function(x) {
  if (!require(x, character.only = TRUE))
  {
    install.packages(x, dep = TRUE)
    if(!require(x, character.only = TRUE)) stop("Package not found")
  }
}

## These lines load the required packages
packages  =  c('data.table','tidyverse','haven','foreign','stargazer','lubridate','knitr','xtable','tables','kableExtra','car','stringr','styler','readxl','magrittr','sjmisc','ggplot2','ggpubr','ggnewscale','bookdown','scales','quantmod','distr6','plyr','forcats','ggrepel','gdata','stringdist','SparseM','quantreg','mfx','erer','margins','moments','rnaturalearth','DescTools','tseries','blorr','janitor','BBmisc')
## you can add more packages here

lapply(packages, pkgTest)

rm(packages,pkgTest)

```


0. Import dataset and missing cpi analysis
```{r import0,echo=FALSE,warning=FALSE,message=FALSE,results='hide'}

setwd("c:/Users/lilac2/Box/GIEWS_Project/GIEWS/Final")

maize_prices<-read_dta("./Data/maizeprices_290821.dta")
cropdata<-read_dta("./Data/cropdata_290821.dta")
seasons<-read_dta("./Data/seasons.dta")

  
missingcpi=maize_prices%>%#3029 observations from Somalia and 2224 observations from 2021
   filter(is.na(price_real))

#missingyield=maize_prices%>%#140 observations from South Sudan and 965 observations from Niger in 2020/2021
 #  filter(is.na(yield_kgha))
 
#eliminate the observations missing real prices and other errors     
maize<-maize_prices%>%
   filter(!is.na(price_real))%>%
  filter(!(market=="Kirundo"&year==2015&month==1&commodity=="Maize (white)"&market_type=="Retail"),
         !(market=="Kasempa"&year==2020&month==3&commodity=="Maize (white)"&market_type=="Retail")) #errors in WFP dataset with price=1 and price=23 respectively, found during skewness analysis


rm(missingcpi)

```


1. Map of markets
```{r map4,echo=FALSE,warning=FALSE,message=FALSE}

setwd("C:/Users/lilac2/Box/GIEWS_Project/GIEWS/Final/Output/")

markets=maize%>%
  dplyr::select(country,market,market_type,lat,lon)%>%
   mutate(country=gsub("Democratic Republic of the Congo","DR Congo",country))%>%
  mutate(country=gsub("Central African Republic","CAR",country))

countries=markets%>%
  group_by(country)%>%
  dplyr::summarise(across(lat:lon,mean))


world <- ne_countries(scale = "medium", returnclass = "sf")

ggplot(data = world) +
    geom_sf(fill="antiquewhite") +
    geom_point(data=markets, aes(x = lon, y = lat,fill=market_type), size = 1, 
        shape = 23)+
   geom_label_repel(data = countries, aes(x=lon,y=lat, label = country), size =2,nudge_x= 0.15,
    direction    = "y",
    segment.size = 0.2)+
    coord_sf(xlim = c(-20,50), ylim = c(-35, 25))+
  theme(panel.grid.major = element_line(color = gray(0.5), linetype = "dashed", 
        size = 0.25), panel.background = element_rect(fill = "aliceblue"),
        legend.position=c(0.35,0.35),legend.background = element_rect(fill="aliceblue"),legend.title=element_blank(),
        axis.text.x=element_blank(),axis.ticks.x=element_blank(),axis.title.x=element_blank(),
        axis.text.y=element_blank(),axis.ticks.y=element_blank(),axis.title.y=element_blank())


ggsave("market_map.PNG",width=12,height=9)

rm(markets,countries,world)

```


2. Assign planting and harvest season months
```{r assign1,echo=FALSE,warning=FALSE,message=FALSE,results='hide'}

#Reminder: note h1x,h2x,p1x,p2x if planting or harvest seasons that cross the end of the year, e.g. harvest starts in Dec and ends in Jan 
maize<-maize%>%
   mutate(yyyymm=paste(year,formatC(month,width=2,flag="0"),sep="-"))%>%
  mutate(monthtype1=if_else(note_p1x==0&month>=main_plant_start & month<=main_plant_end,paste0("planting1_",year),#for nonwrapped planting season
                          if_else(note_p1x==1&month>=main_plant_start,paste0("planting1_",year), #for months at the end of the year
                          if_else(note_p1x==1&month<=main_plant_end,paste0("planting1_",year-1), #assume months at the beginning of the year belong with prior year's planting season
                    if_else(note_h1x==0&month>=main_harvest_start & month<=main_harvest_end,paste0("harvest1_",year),#for nonwrapped harvest season
                            if_else(note_h1x==1&month>=main_harvest_start,paste0("harvest1_",year), #for months at the end of the year
                               if_else(note_h1x==1&month<=main_harvest_end,paste0("harvest1_",year-1),"")))))),#assume months at the beginning of the year belong with prior year's harvest season
      monthtype2=if_else(note_p2x==0&month>=second_plant_start & month<=second_plant_end,paste0("planting2_",year), #for nonwrapped planting season
                               if_else(note_p2x==1&month>=second_plant_start,paste0("planting2_",year), #for months at the end of the year
                               if_else(note_p2x==1&month<=second_plant_end,paste0("planting2_",year-1), #for months at the beginning of the year
                       if_else(note_h2x==0&month>=second_harvest_start & month<=second_harvest_end,paste0("harvest2_",year),#for nonwrapped harvest season
                               if_else(note_h2x==1&month>=second_harvest_start,paste0("harvest2_",year), #for months at the end of the year
                               if_else(note_h2x==1&month<=second_harvest_end,paste0("harvest2_",year-1),"")))))))%>% #for months at the beginning of the year
   mutate(date=parse_date_time(yyyymm,"ym"))%>%
  dplyr::select(country,region,market,lat,lon,commodity,market_type,currency,year,month,price_real,monthtype1,monthtype2,contains("harvest"),date)
 
yield=cropdata%>%
  dplyr::select(country,year,yield_kgha)

rm(cropdata)

```



3. Calculate returns from min harvest to max "lean season" (3 months pre-harvest)
```{r harvest.calc,echo=FALSE,include=FALSE}

#isolate the month of harvest begin for the main season and make a full set for all years and markets
beginharvest1=maize%>%
   unite("temp",c("country","region","market","commodity","market_type","main_harvest_start"),sep="_")%>%
  dplyr::select(temp)%>%
group_by(temp)%>%
  slice(1)%>%
  ungroup()

years=seq(2000,2021,by=1)
beginharvest1=expand.grid(beginharvest1$temp,years,stringsAsFactors = TRUE)%>%
  separate("Var1",c("country","region","market","commodity","market_type","main_harvest_start"),sep="_")%>%
  mutate(hbegin1=paste(Var2,formatC(main_harvest_start,width=2,flag="0"),sep="-"))%>%
         mutate(hbegin_date1=parse_date_time(hbegin1,"ym"))%>%
  dplyr::select(1:5,hbegin_date1)

#repeat for second season
beginharvest2=maize%>%
   unite("temp",c("country","region","market","commodity","market_type","main_harvest_start"),sep="_")%>%
  dplyr::select(temp)%>%
group_by(temp)%>%
  slice(1)%>%
  ungroup()

beginharvest2=expand.grid(beginharvest2$temp,years,stringsAsFactors = TRUE)%>%
  separate("Var1",c("country","region","market","commodity","market_type","second_harvest_start"),sep="_")%>%
  mutate(hbegin2=paste(Var2,formatC(second_harvest_start,width=2,flag="0"),sep="-"))%>%
         mutate(hbegin_date2=parse_date_time(hbegin2,"ym"))%>%
  dplyr::select(1:5,hbegin_date2)



#rejoin the harvest month begin and identify the three months prior to harvest, and the maximum price during that period and calculate returns
lean1=maize%>%  
  left_join(beginharvest1,by=c("country","region","market","commodity","market_type"))%>%
    mutate(duration1=interval(hbegin_date1,date))%>%
       mutate(duration1=duration1%/%months(1))%>%  
      filter(duration1%in%-3:-1)%>%
  mutate(monthtype1=paste0("lean1_",year(hbegin_date1)-1))%>% #shift the lean season year to reflect the prior year harvest
  group_by(country,region,commodity,market_type,market,monthtype1)%>% #group by lean season crop year to find the price within the lean seasons for that crop year
  dplyr::summarise(lmax1=max(price_real,na.rm=TRUE),lmin1=min(price_real,na.rm=TRUE))%>%    
  ungroup()%>%
  unite("temp",c("country","region","market","commodity","market_type"),sep="_")%>%
   separate(monthtype1,c("monthtype1","cropyear"),"_")%>%
  mutate(cropyear=as.numeric(cropyear))%>%
  dplyr::select(temp,cropyear,lmax1,lmin1)
  

#repeat for second season
lean2=maize%>%  
  left_join(beginharvest2,by=c("country","region","market","commodity","market_type"))%>%
  mutate(duration2=interval(hbegin_date2,date))%>%
       mutate(duration2=duration2%/%months(1))%>%  
      filter(duration2%in%-3:-1)%>%
  mutate(monthtype2=paste0("lean2_",year(hbegin_date2)-1))%>%#shift the lean season year to reflect the prior year harvest
  group_by(country,region,commodity,market_type,market,monthtype2)%>% #group by crop year to find the price within lean months for that crop year
  dplyr::summarise(lmax2=max(price_real,na.rm=TRUE),lmin2=min(price_real,na.rm=TRUE))%>%    
  ungroup()%>%
  unite("temp",c("country","region","market","commodity","market_type"),sep="_")%>%
  separate(monthtype2,c("monthtype2","cropyear"),"_")%>%
  mutate(cropyear=as.numeric(cropyear))%>%
  dplyr::select(temp,cropyear,lmax2,lmin2)


#find min and max harvest price (main season)
harvest1 = maize%>% 
   separate(monthtype1,c("monthtype1","cropyear"),"_")%>%
  mutate(cropyear=as.numeric(cropyear))%>%
  filter(monthtype1=="harvest1")%>% #find all the harvest months for the main season
  arrange(country,region,commodity,market_type,market,year,month)


harvest1_minmax=harvest1%>% 
  group_by(country,region,commodity,market_type,market,cropyear,monthtype1)%>% #group by crop year to find the price within harvest months for that crop year
  dplyr::summarise(minprice=min(price_real,na.rm=TRUE),maxprice=max(price_real,na.rm=TRUE))%>%    
  ungroup()%>%
    unite("temp",c("country","region","market","commodity","market_type"),sep="_")%>%
  pivot_wider(names_from = monthtype1,values_from=c("minprice","maxprice"))%>%
  dplyr::rename(hmin1=minprice_harvest1,hmax1=maxprice_harvest1)%>%
  dplyr::select(temp,cropyear,hmin1,hmax1)


#find min and max harvest price (second season)
harvest2 = maize%>% 
   separate(monthtype2,c("monthtype2","cropyear"),"_")%>%
  mutate(cropyear=as.numeric(cropyear))%>%
  filter(monthtype2=="harvest2")%>% #find all the harvest months for the main season
  arrange(country,region,commodity,market_type,market,year,month)

harvest2_minmax=harvest2%>% 
  group_by(country,region,commodity,market_type,market,cropyear,monthtype2)%>% #group by crop year to find the price within harvest months for that crop year
  dplyr::summarise(minprice=min(price_real,na.rm=TRUE),maxprice=max(price_real,na.rm=TRUE))%>%    
  ungroup()%>%
    unite("temp",c("country","region","market","commodity","market_type"),sep="_")%>%
  pivot_wider(names_from = monthtype2,values_from=c("minprice","maxprice"))%>%
  dplyr::rename(hmin2=minprice_harvest2,hmax2=maxprice_harvest2)%>%
  dplyr::select(temp,cropyear,hmin2,hmax2)


###connect and calculate returns
returns1=full_join(lean1,harvest1_minmax,by=c("temp","cropyear"))%>%
  mutate(returns1=(lmax1-hmin1)/hmin1,  #calculate max returns
         noarb1=if_else(lmax1<=hmin1,1,0))

#repeat for second season
returns2=full_join(lean2,harvest2_minmax,by=c("temp","cropyear"))%>%
  mutate(returns2=(lmax2-hmin2)/hmin2,  #calculate returns
         noarb2=if_else(lmax2<=hmin2,1,0))

#rejoin the returns 
returns_con=full_join(returns1,returns2,by=c("temp","cropyear"))%>%
  separate("temp",c("country","region","market","commodity","market_type"),sep="_")%>%
  arrange(country,region,market,commodity,market_type,cropyear)%>%
  left_join(yield,by=c("country","cropyear"="year"))


rm(harvest1_minmax,harvest2_minmax,lean1,lean2,beginharvest1,beginharvest2,years)

```



4. Calculate intratemporal returns by varying the number of months after harvest end
```{r harvest.calc,echo=FALSE,include=FALSE}

#isolate the month of harvest end for the main season and determine the price decile for the country and market type
harvest1_end=harvest1%>%
  filter(month==main_harvest_end)%>%
  mutate(hend1=price_real,hend=paste(cropyear,formatC(month,width=2,flag="0"),sep="-"))%>%
  mutate(hend_date1=parse_date_time(hend,"ym"))%>%
 dplyr::select(country,region,market,commodity,market_type,cropyear,hend_date1,hend1)
  

#repeat for second season
harvest2_end = harvest2%>%
  filter(month==second_harvest_end)%>%
  mutate(hend2=price_real,hend=paste(cropyear,formatC(month,width=2,flag="0"),sep="-"))%>%
  mutate(hend_date2=parse_date_time(hend,"ym"))%>%
 dplyr::select(country,region,market,commodity,market_type,cropyear,hend_date2,hend2)


#rejoin the harvest month end and calculate returns for every month from the harvest end, keeping only the months within a year after harvest, and calculate returns
returns_dur1=maize%>%  
  left_join(harvest1_end,by=c("country","region","market","commodity","market_type"))%>%
  mutate(duration1=interval(hend_date1,date),returns1=(price_real-hend1)/hend1,arb1=if_else(price_real>hend1,1,0))%>%
  mutate(duration1=duration1%/%months(1),noarb1=if_else(arb1==0,1,0))%>%
  filter(duration1%in%1:11)%>%
  left_join(yield,by=c("country","cropyear"="year"))%>%
  dplyr::select(-lat,-lon,-currency,-contains("_harvest_"),-contains("monthtype"))

#repeat for second season
returns_dur2=maize%>%
  left_join(harvest2_end,by=c("country","region","market","commodity","market_type"))%>%
    mutate(duration2=interval(hend_date2,date),returns2=(price_real-hend2)/hend2,arb2=if_else(price_real>hend2,1,0))%>%
  mutate(duration2=duration2%/%months(1),noarb2=if_else(arb2==0,1,0))%>%
filter(duration2%in%1:11)%>%
    left_join(yield,by=c("country","cropyear"="year"))%>%
  dplyr::select(-lat,-lon,-currency,-contains("_harvest_"),-contains("monthtype"))

#rejoin the returns 
#returns_dur=full_join(returns_dur1,returns_dur2,by=c("country","region","market","commodity","market_type","year","month","price_real","date"))%>%
 # arrange(country,region,market,commodity,year,month)

rm(harvest1,harvest2,harvest1_end,harvest2_end)

```



5. Create summary data sets
```{r summary5,echo=FALSE}

#minyears of data (y) and min number of markets (m)
y=5
m=10

## Seasonal returns for primary and second maize season data set
season1=returns_con%>%
  filter(is.finite(returns1))%>%
  group_by(country,region,commodity,market_type,market)%>%
  filter(n()>=y)%>%
  ungroup()%>%
  group_by(country,commodity,market_type)%>%
  filter(n_distinct(market)>=m)%>% 
  ungroup()%>%
  dplyr::select(1:6,hmin1,lmax1,returns1,noarb1,yield_kgha)
  

season2=returns_con%>%
  filter(is.finite(returns2))%>%
  group_by(country,region,commodity,market_type,market)%>%
  filter(n()>=y)%>%
  ungroup()%>%
  group_by(country,market_type)%>%
  filter(n_distinct(market)>=m)%>% 
  ungroup()%>%
  dplyr::select(1:6,hmin2,lmax2,returns2,noarb2,yield_kgha)

season=season1%>%
  full_join(season2,by=c("country","region","commodity","market","market_type","cropyear","yield_kgha"))



#Seasonal returns (MARKET LEVEL)
season_mkt=season%>%
  group_by(country,region,commodity,market_type,market)%>%
  dplyr::summarise(across(contains("returns"),list(e=mean),na.rm=TRUE,.names = "{.fn}.{.col}"),
                  across(starts_with("noarb"),~sum(.x,na.rm=TRUE),.names = "n_season_{.col}"),
                  n.yrs1=length(cropyear[is.finite(returns1)]),n.yrs2=length(cropyear[is.finite(returns2)]))%>%
  ungroup()%>%
  mutate(pct_season1=n_season_noarb1/n.yrs1,pct_season2=n_season_noarb2/n.yrs2)%>%
 dplyr::select(-contains("n_"))

#%>%dplyr::rename(n_season=n.returns1)

#583 markets with 5 or more years of data in countries with at least 10 markets (retail and wholesale)

pctp=function(x){
  y=mean(x[x>0],na.rm=TRUE)
}

pctn=function(x){
  y=mean(x[x<=0],na.rm=TRUE)
}

#Seasonal returns (COUNTRYLEVEL)
season_country=season%>%
  group_by(country,commodity,market_type)%>%
   dplyr::summarise(across(contains("returns"),list(e=mean,pos=~pctp(.x),neg=~pctn(.x)),na.rm=TRUE,.names = "{.fn}.{.col}"),
                    across(contains("noarb"),~sum(.x,na.rm=TRUE),.names = "n_season_{.col}"),
                   n.mkt1=n_distinct(market[is.finite(returns1)]),n.mkt2=n_distinct(market[is.finite(returns2)]),
                   n.yrs1=length(market[is.finite(returns1)]),n.yrs2=length(market[is.finite(returns2)]))%>%
       ungroup()%>%
  mutate(pct_season1=n_season_noarb1/n.yrs1,
         pct_season2=n_season_noarb2/n.yrs2)%>%
  dplyr::select(-starts_with("n_"))

#make a list of years covered
all_years=season%>%
  arrange(country,market_type,cropyear)%>%
  group_by(country,market_type)%>%
  dplyr::summarise(minyr=min(cropyear),maxyr=max(cropyear))%>%
  mutate(years=paste(minyr,maxyr,sep="-"))%>%
dplyr::select(country,market_type,years)%>%
  ungroup()
 
#add list of years to country data
season_country=season_country%>%
  left_join(all_years,by=c("country","market_type"))%>%
  dplyr::select(country,commodity,market_type,years,contains("1"),contains("2"))


rm(all_years,season1,season2,pctn,pctp)
 
```



6. Missing data analysis
```{r missing,echo=FALSE,include=FALSE}

setwd("C:/Users/lilac2/Box/GIEWS_Project/GIEWS/Final/Output/")

# of markets per country with any price data
# of years per market
# of months 
marketstats=maize_prices%>%
  filter(market_type=="Retail")%>%
  group_by(country,commodity,market_type,region,market,year)%>% #
  dplyr::mutate(n_mo=n_distinct(month))%>%
  ungroup()%>%
  group_by(country,commodity,market_type,region,market)%>%
  dplyr::mutate(n_yr=n_distinct(year))%>%
  ungroup()%>%
  group_by(country,commodity,market_type)%>%
  dplyr::summarise(n_years=n_distinct(year),n_mkt=n_distinct(market))%>%
                  #n_mktfullyr=n_distinct(market[n_mo==12]),n_mkt10mo=n_distinct(market[n_mo>=10])
  ungroup()


#post identification of crop year and min 5 year and 10 markets, note missing data in primary season retail markets
missing1=returns1%>%
  separate("temp",c("country","region","market","commodity","market_type"),sep="_")%>%
  filter(is.finite(returns1)&market_type=="Retail")%>%
  group_by(country,region,commodity,market_type,market)%>%
  dplyr::summarise(n.yrs1=length(cropyear[is.finite(returns1)]))%>%
  ungroup()%>%
 group_by(country,commodity,market_type)%>%
  dplyr::summarise(n_mkt5yr=n_distinct(market[n.yrs1>=5]),n_obs=n())%>%
 ungroup()

marketstats=left_join(marketstats,missing1,by=c("country","commodity","market_type"))%>%
 arrange(desc(n_mkt5yr))%>%
  mutate(country=revalue(country,c("Democratic Republic of the Congo"="DR Congo","Central African Republic"="CAR")))%>%
  dplyr::select(-market_type)

marketstats[is.na(marketstats)]=0
 

print=xtable(marketstats,type="latex")
names(print)<-c("Country","Commodity","Total Years","Total Markets","N markets 5+ years","N obs for those mkts")
print(print,file=paste0("C:/Users/lilac2/Box/GIEWS_Project/GIEWS/Final/Output/missingstats1_",format(Sys.Date(),"%d_%m_%y"),".tex"),include.rownames=FALSE)

#note the loss of somalia due to lack of CPI data

#analyze causes of missingness
missing1=returns1%>%
  separate("temp",c("country","region","market","commodity","market_type"),sep="_")%>%
  filter(market_type=="Retail")%>%
  mutate(status=if_else(is.finite(hmin1)&is.finite(lmax1),"both prices exist",
                         if_else(is.na(hmin1)&is.finite(lmax1),"no harvest price",
                                 if_else(is.finite(hmin1)&is.na(lmax1),"no lean price","neither"))),
         returns_yn=if_else(is.finite(returns1),1,0),country=as.factor(country))%>%
  mutate(country=revalue(country,c("Democratic Republic of the Congo"="DR Congo","Central African Republic"="CAR")))%>%
  dplyr::select(country,market,cropyear,status,returns1,returns_yn)

#avg returns
missing_m1=missing1%>%
  group_by(country)%>%
  dplyr::summarise(meanreturn=mean(returns1,na.rm=TRUE))%>%
  filter(is.finite(meanreturn))%>%
  ungroup()

missing_mm=missing_m1%>%
  add_row(country="Overall average",meanreturn=mean(missing1$returns1,na.rm=TRUE))%>%
  dplyr::mutate(across(contains("return"),~paste0(sprintf("%.1f",.*100),"%")))

missing1$country=fct_infreq(missing1$country)  

t=missing1%>%
  tabyl(country,status,show_na=FALSE)%>%
   adorn_totals(c("row","col"))%>%
  adorn_percentages("row") %>%
  adorn_pct_formatting(digits = 1) %>%
  adorn_ns()%>%
  as.tibble()%>%
  full_join(missing_mm,by="country")

t[is.na(t)]=""

print=xtable(t,type="latex")
names(print)<-c("Country","Both prices exist","No harvest Price","No lean price","Total bservations","Mean return")
print(print,file=paste0("C:/Users/lilac2/Box/GIEWS_Project/GIEWS/Final/Output/missingstats2_",format(Sys.Date(),"%d_%m_%y"),".tex"),include.rownames=FALSE)


missing_m1$meanreturn=missing_m1$meanreturn*100


ggplot()+
  geom_bar(data=missing1,aes(x=country,stat="identity",fill=status))+
  scale_fill_manual(values=c("gray","pink","purple"),breaks=c("both prices exist","no harvest price","no lean price"),labels=c("both prices exist","no harvest price","no lean price"),name="* average returns (%)")+
  geom_point(data=missing_m1,aes(x=country,y=meanreturn*10),size=3,shape=8)+
  scale_y_continuous(name="Count of crop years",sec.axis=sec_axis(trans~./10,name=""),expand=c(0,0),limits=c(0,1400))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1),panel.background = element_blank(),
        axis.line = element_line(colour = "black"),panel.grid.major.y = element_line(colour = "black"),panel.grid.minor.y = element_line(colour = "black"))

ggsave("missingness.PNG",width=12,height=9)

rm(list=ls(pattern="missing"),t,print,marketstats)

```



7. Look at measures of skewness and kurtosis in primary retail markets
```{r skew6,echo=FALSE,include=FALSE}

mlist=unlist(season_mkt%>%filter(market_type=="Retail"&n.yrs1>0)%>%distinct(country,region,commodity,market_type,market)%>%unite("z",1:5,sep="_"))
#506 retail markets

skew_mkt=maize%>%
  unite("z",country,region,commodity,market_type,market,sep="_")%>%
  filter(z%in%mlist)%>%
  separate(z,c("country","region","commodity","market_type","market"),sep="_")%>%
  group_by(country,commodity,market,market_type)%>%
  dplyr::summarise(nobs=n(),cv=(mean(price_real)/sd(price_real)),
                   skew=skewness(price_real),kurt=kurtosis(price_real))%>%
  mutate(n_skew=if_else(skew<=0,1,0),n_kurt=if_else(kurt<=0,1,0))

#no evidence of negative kurtosis in any markets

skew_country=skew_mkt%>%
  group_by(country,commodity,market_type)%>%
  dplyr::summarise(across(c(cv,kurt,skew),mean,na.rm=TRUE),across(starts_with("n"),sum,na.rm=TRUE),n_mkt=n())%>%
  dplyr::mutate(n_skew_pct=n_skew/n_mkt,n_kurt_pct=n_kurt/n_mkt)%>%
  dplyr::mutate(across(c(n_skew_pct,n_kurt_pct),~paste0(sprintf("%.1f",.*100),"%")),
            across(c(cv,skew,kurt),round,3))%>%
  ungroup()%>%
  dplyr::select(country,n_mkt,skew,n_skew_pct)%>%
mutate(country=revalue(country,c("Democratic Republic of the Congo"="DR Congo")))

#KPSS test for stationarity
extreme1_mkt=season%>%
  unite("z",country,region,commodity,market_type,market,sep="_")%>%
  filter(z%in%mlist)%>%
  separate(z,c("country","region","commodity","market_type","market"),sep="_")%>%
  #filter(market_type=="Retail"&is.finite(returns1))%>%
  unite("c_mkt",c("country","market"))%>%
  group_by(c_mkt)%>%
  arrange(c_mkt,cropyear)%>%
  dplyr::summarise(pval=ifelse(n()<=3,as.numeric(NA),kpss.test(ts(returns1))$p.value))

nrow(subset(extreme1_mkt,pval<0.05))
#15 markets


print=xtable(skew_country,type="latex")
names(print)<-c("Country","Markets","Average Market Skewness ","Percent Markets Negative Skew")
print(print,file=paste0("C:/Users/lilac2/Box/GIEWS_Project/GIEWS/Final/Output/skew_kurt_",format(Sys.Date(),"%d_%m_%y"),".tex"),include.rownames=FALSE)

rm(skew_mkt,skew_country,print)

```



8. Print summary datasets
```{r print7,echo=FALSE}

setwd("C:/Users/lilac2/Box/GIEWS_Project/GIEWS/Final/Output")

#summary datasets for main season
sum_retail1=season_country%>%
  filter(market_type=="Retail"&n.yrs1>0)%>%
  dplyr::select(country,years,contains("1"))%>%
  dplyr::summarise(across(starts_with("n."),sum),across(starts_with("pct_"),mean,na.rm=TRUE),across(contains("returns"),mean,na.rm=TRUE))%>%
                   mutate(country="Total",commodity=" ",years=" ")%>%
  dplyr::select(country,years,n.mkt1,n.yrs1,pct_season1,e.returns1,pos.returns1,neg.returns1)

sum_wholesale1=season_country%>%
  filter(market_type=="Wholesale"&n.yrs1>0)%>%
 dplyr::select(country,years,contains("1"))%>%
  dplyr::summarise(across(starts_with("n."),sum),across(starts_with("pct_"),mean,na.rm=TRUE),across(contains("returns"),mean,na.rm=TRUE))%>%
                   mutate(country="Total",commodity=" ",years=" ")%>%
  dplyr::select(country,years,n.mkt1,n.yrs1,pct_season1,e.returns1,pos.returns1,neg.returns1)

#main season (retail)
retail1=season_country%>%
  filter(market_type=="Retail"&n.yrs1>0)%>%
  dplyr::select(country,years,n.mkt1,n.yrs1,pct_season1,e.returns1,pos.returns1,neg.returns1)%>%
  rbind(sum_retail1)%>%
  dplyr::mutate(across(contains("pct"),~paste0(sprintf("%.1f",.*100),"%")),across(contains("returns"),~paste0(sprintf("%.1f",.*100),"%")),
                country=revalue(country,c("Democratic Republic of the Congo"="DR Congo")))


#main season (wholesale)
wholesale1=season_country%>%
filter(market_type=="Wholesale"&n.yrs1>0)%>%
  dplyr::select(country,years,n.mkt1,n.yrs1,pct_season1,e.returns1,pos.returns1,neg.returns1)%>%
  rbind(sum_wholesale1)%>%
  dplyr::mutate(across(contains("pct"),~paste0(sprintf("%.1f",.*100),"%")),across(contains("returns"),~paste0(sprintf("%.1f",.*100),"%")))


#summary datasets for second season
sum_retail2=season_country%>%
  filter(market_type=="Retail"&n.yrs2>0)%>%
  dplyr::select(country,years,contains("2"))%>%
  dplyr::summarise(across(starts_with("n."),sum),across(starts_with("pct_"),mean,na.rm=TRUE),across(contains("returns"),mean,na.rm=TRUE))%>%
                   mutate(country="Total",commodity=" ",years=" ")%>%
  dplyr::select(country,years,n.mkt2,n.yrs2,pct_season2,e.returns2,pos.returns2,neg.returns2)

sum_wholesale2=season_country%>%
  filter(market_type=="Wholesale"&n.yrs2>0)%>%
 dplyr::select(country,years,contains("2"))%>%
  dplyr::summarise(across(starts_with("n."),sum),across(starts_with("pct_"),mean,na.rm=TRUE),across(contains("returns"),mean,na.rm=TRUE))%>%
                   mutate(country="Total",commodity=" ",years=" ")%>%
  dplyr::select(country,years,n.mkt2,n.yrs2,pct_season2,e.returns2,pos.returns2,neg.returns2)


#second season (retail)
retail2=season_country%>%
  filter(market_type=="Retail"&n.yrs2>0)%>%
  dplyr::select(country,years,n.mkt2,n.yrs2,pct_season2,e.returns2,pos.returns2,neg.returns2)%>%
 rbind(sum_retail2)%>%
  dplyr::mutate(across(contains("pct"),~paste0(sprintf("%.1f",.*100),"%")),across(contains("returns"),~paste0(sprintf("%.1f",.*100),"%")))



#second season (wholesale)
wholesale2=season_country%>%
  filter(market_type=="Wholesale"&n.yrs2>0)%>%
  dplyr::select(country,years,n.mkt2,n.yrs2,pct_season2,e.returns2,pos.returns2,neg.returns2)%>%
 rbind(sum_wholesale2)%>%
  dplyr::mutate(across(contains("pct"),~paste0(sprintf("%.1f",.*100),"%")),across(contains("returns"),~paste0(sprintf("%.1f",.*100),"%")))



header<-c("Country","Years","Markets","Market-Years",
                "Frequency of Negative Returns","Average Total Returns","Average Positive Returns","Average Negative Returns")


print=xtable(retail1,type="latex")
names(print)<-header
print(print,file=paste0("./retailprices_main_",format(Sys.Date(),"%d_%m_%y"),".tex"),include.rownames=FALSE)

print=xtable(retail2,type="latex")
names(print)<-header
print(print,file=paste0("./retailprices_second_",format(Sys.Date(),"%d_%m_%y"),".tex"),include.rownames=FALSE)

print=xtable(wholesale1,type="latex")
names(print)<-header
print(print,file=paste0("./wholesaleprices_main_",format(Sys.Date(),"%d_%m_%y"),".tex"),include.rownames=FALSE)


###ltd for presentations
#main season (retail)
retail1_ltd=retail1%>%
  dplyr::select(country,e.returns1,pct_season1,neg.returns1)

print=xtable(retail1_ltd,type="latex")
names(print)<-c("Country","Average Total Returns","Frequency of Negative Returns","Average Negative Returns")
print(print,file=paste0("./retailprices_ltd_",format(Sys.Date(),"%d_%m_%y"),".tex"),include.rownames=FALSE)


rm(list=ls(pattern="sum_"),retail1,retail2,wholesale1,wholesale2,print,header)



```


8. Output figure for paper2/3: Dot plot of frequency of negative returns vs severity of trend (average returns)
```{r output8,echo=FALSE}

setwd("C:/Users/lilac2/Box/GIEWS_Project/GIEWS/Final/Output/")

cb1=season_mkt%>%
  filter(market_type=="Retail"&is.finite(e.returns1))


cb1plot=ggplot()+
   geom_point(data=cb1,aes(x=pct_season1*100,y=e.returns1*100,size=n.yrs1))+ scale_y_continuous(name="Average returns to storage (%)",limits=c(-50,200),breaks=seq(-50,200,50),expand=c(0,0)) +  scale_x_continuous(name="% of seasons with negative returns",limits=c(0,100),breaks=seq(0,100,20)) + 
   theme(panel.grid.minor = element_blank(),panel.background = element_blank(),panel.grid.major = element_line(color="lightgray"),legend.position = c(1, 1),legend.justification = c(1, 1),
         axis.line = element_line(color="black"))+guides(size = guide_legend(reverse = TRUE))+
  geom_hline(yintercept=0,color="darkgray")+ scale_size(range = c(0.5,3),breaks=c(5,10,15,20),name="Number of \n market-years")

print(cb1plot)

ggsave("seasondotplot.png")

 
neg_all=cb1%>%filter(pct_season1==1) #0
pos_all=cb1%>%filter(pct_season1==0) #99
#neg_country=unique(neg_all$country) #1 country
pos_country=unique(pos_all$country) #11 different countries
#neg_market=unique(neg_all$market) #1 market
pos_market=unique(pos_all$market) #99 different markets
#neg_all=season%>%filter(market%in%neg_market)#5 total observations for that 1 markets
pos_all=season%>%filter(market%in%pos_market)#839 total observations for those 72 markets

#neg_year=unique(neg_all$cropyear) #5 different years
pos_year=unique(pos_all$cropyear) #21 different years



rm(cb1,cb1plot,list=ls(pattern="neg_")) 
rm(list=ls(pattern="pos_"))

```


9. Output figure for paper1/2/3: Boxplot of frequency of negative returns over time 
```{r output9,echo=FALSE}

setwd("C:/Users/lilac2/Box/GIEWS_Project/GIEWS/Final/Output/")


dot= ggplot()+geom_jitter(data=subset(season,market_type=="Retail"),aes(x=factor(cropyear),y=returns1*100,color=yield_kgha),size=1.0,alpha=0.75)+ #geom_hline(yintercept=0,color="red",position="identity")+
  scale_color_gradient2(low="gray80",high="gray10",na.value="gray",name="Yield (kg/ha)",limits=c(0,5000))+
#scale_color_gradient2(low="chartreuse",high="darkgreen",na.value="gray",name="Yield (kg/ha)",limits=c(0,4000))+
  scale_y_continuous(name="Returns to storage (%)",limits=c(-100,500),breaks=seq(-100,500,100),expand=c(0,0))+
  scale_x_discrete(name="Year",breaks=c("2000","2004","2008","2012","2016","2020"),labels=c("2000","2004","2008","2012","2016","2020"))+
  geom_hline(yintercept=0,color="red",position="identity")+
  theme(panel.grid.major = element_line(color="lightgray"),panel.grid.minor = element_blank(), panel.background = element_blank(),axis.line = element_line(color="black"),legend.position = c(1, 1),legend.justification = c(1, 1))
  #geom_jitter(data=subset(time,dpct<=0),aes(x=year, y=dpct,color="red",size=yield_kgha),alpha=0.5)+
 #geom_jitter(data=subset(time,dpct>0),aes(x=year,y=dpct,color="black",size=yield_kgha),alpha=0.5)+
#scale_color_manual(values=c("black","red")) + 
#scale_y_continuous(name="Seasonal Returns (%)",limits=c(-100,500),breaks=seq(-100,500,100))+
  # geom_text(data=time,aes(x=2010,y=450,label="High Planting Price, Low Harvest Price",color="black"),size=4)+
   # geom_text(data=time,aes(x=2010,y=-95,label="High Harvest Price, Low Planting Price",color="red"),size=4)
print(dot)
ggsave("cropyear_returns_dot.PNG")


box= ggplot()+geom_boxplot(data=subset(season,market_type=="Retail"),aes(x=factor(cropyear),y=returns1*100),outlier.shape=1,position="dodge") + geom_hline(yintercept=0,color="red",position="identity")+
 scale_y_continuous(name="Returns to storage (%)", limits=c(-100,500),breaks=seq(-100,500,100))+ scale_x_discrete(name="Year",breaks=c("2000","2004","2008","2012","2016","2020"))+
    theme(panel.grid.major = element_blank(),legend.position="none",panel.grid.minor = element_blank(), panel.background = element_blank(),axis.line = element_line(color="black"))

print(box)
ggsave("cropyear_returns_box.PNG")

rm(dot,box)




```



10. Plots for distribution of extreme harvest prices and returns (for seasonal returns for primary season)
```{r output10,echo=FALSE}

setwd("C:/Users/lilac2/Box/GIEWS_Project/GIEWS/Final/Output/")

extreme1=season%>%
  filter(market_type=="Retail"&is.finite(returns1))%>%
  group_by(country)%>%
  dplyr::mutate(z_h1=scale(hmin1),h1_d=as.factor(paste0("d",ntile(hmin1,10))))%>%
  ungroup()


extremedot=ggplot()+
  geom_point(data=extreme1,aes(x=z_h1,y=returns1*100,shape=factor(noarb1)),alpha=0.5,size=1)+
  scale_y_continuous(name="Returns to storage for primary maize season (%)",limits=c(-100,500),breaks=seq(-100,500,100),expand=c(0,0)) + 
  scale_x_continuous(name="Z-score of harvest price for primary maize season",limits=c(-3,6),breaks=seq(-3,6,1),expand=c(0,0))+
  scale_shape_manual(values=c(3,1),breaks=c("0","1"),labels=c("Positive Returns","Negative Returns"),name="Returns to Storage")+
  geom_hline(yintercept=0,color="red")+
  theme(panel.grid.minor = element_blank(),axis.line = element_line(color="black"),
        legend.position = c(0.9, 0.9),legend.justification = c(1, 1))

print(extremedot)
ggsave("harvestprices_returns.png")

rm(decile,extremedot)

```



11. OLS and probit regressions on harvest price (for primary maize retail season)
```{r OLSreg11 ,echo=FALSE}

split.df=split(extreme1,extreme1$country)
country.name=names(split.df)

#run with and without cropyear FE as robustness check
table=data.frame(country=as.character())
table_fe=data.frame(country=as.character())

for (i in 1:length(country.name)){
df=split.df[[i]]
cname=country.name[[i]]

#without FE
#OLS 
o=lm(returns1*100~z_h1,data=df) #without FE
s=summary(o)
coef_o=s$coefficients[1,1]
pval_o=s$coefficients[1,4]
rsq_o=s$r.squared

#probit
p=glm(factor(noarb1)~z_h1,data=df,family=binomial(link = "probit"))
pm=probitmfx(factor(noarb1)~z_h1,data=df,atmean=FALSE,robust=TRUE)
rsq_p=as.numeric(PseudoR2(p,which="McFadden"))
coef_p=pm$mfxest[1,1]
pval_p=pm$mfxest[1,4]

cprep=data.frame(cname,coef_o,pval_o,rsq_o,coef_p,pval_p,rsq_p)
table=rbind(table,cprep)

#with FE
#OLS 
o=lm(returns1*100~z_h1+factor(cropyear),data=df) #with FE
s=summary(o)
coef_o=s$coefficients[1,1]
pval_o=s$coefficients[1,4]
rsq_o=s$r.squared

#probit
p=glm(factor(noarb1)~z_h1+factor(cropyear),data=df,family=binomial(link = "probit"))
pm=probitmfx(factor(noarb1)~z_h1+factor(cropyear),data=df,atmean=FALSE,robust=TRUE)
rsq_p=as.numeric(PseudoR2(p,which="McFadden"))
coef_p=pm$mfxest[1,1]
pval_p=pm$mfxest[1,4]

cprep_fe=data.frame(cname,coef_o,pval_o,rsq_o,coef_p,pval_p,rsq_p)
table_fe=rbind(table_fe,cprep_fe)

}

###pooled regressions w.out cropyear FE
o_pool=lm(returns1*100~z_h1+factor(country),data=extreme1)
s_pool=summary(o_pool)
rsq_o_pool=s_pool$r.squared
p_pool=glm(factor(noarb1)~z_h1+factor(country),data=extreme1,family=binomial(link = "probit"))
rsq_p_pool=PseudoR2(p_pool,which="McFadden")

table=table%>%
  add_row(cname="CC Average",rsq_o=mean(table$rsq_o),rsq_p=mean(table$rsq_p))%>%
   add_row(cname="Pooled",rsq_o=rsq_o_pool,rsq_p=rsq_p_pool)%>%
  mutate(stars_o=ifelse(pval_o < .01, "***", ifelse(pval_o < .05, "** ", ifelse(pval_o < .1, "* ", " "))),
         stars_p=ifelse(pval_p < .01, "***", ifelse(pval_p < .05, "** ", ifelse(pval_p < .1, "* ", " "))))%>%
  dplyr::mutate(cp_o=paste(round(coef_o,3),stars_o,sep=""),cp_p=paste(round(coef_p,3),stars_p,sep=""),
         across(starts_with("rsq"),round,2))%>%
  dplyr::select(cname,cp_o,rsq_o,cp_p,rsq_p)

###pooled regressions w/cropyear FE
o_pool=lm(returns1*100~z_h1+factor(cropyear)+factor(country),data=extreme1)
s_pool=summary(o_pool)
rsq_o_pool=s_pool$r.squared
p_pool=glm(factor(noarb1)~z_h1+factor(cropyear)+factor(country),data=extreme1,family=binomial(link = "probit"))
rsq_p_pool=PseudoR2(p_pool,which="McFadden")


table_fe=table_fe%>%
  add_row(cname="CC Average",rsq_o=mean(table_fe$rsq_o),rsq_p=mean(table_fe$rsq_p))%>%
   add_row(cname="Pooled",rsq_o=rsq_o_pool,rsq_p=rsq_p_pool)%>%
  mutate(stars_o=ifelse(pval_o < .01, "***", ifelse(pval_o < .05, "** ", ifelse(pval_o < .1, "* ", " "))),
         stars_p=ifelse(pval_p < .01, "***", ifelse(pval_p < .05, "** ", ifelse(pval_p < .1, "* ", " "))))%>%
  dplyr::mutate(cp_o=paste(round(coef_o,3),stars_o,sep=""),cp_p=paste(round(coef_p,3),stars_p,sep=""),
         across(starts_with("rsq"),round,2))%>%
  dplyr::select(cname,cp_o,rsq_o,cp_p,rsq_p)


t=xtable(table,type="latex",auto=TRUE)
names(t)<-c("Country","Harvest price z-score (OLS)","R squared","Harvest price z-score (probit)","Pseudo-R squared")
print(t,file=paste0("c:/Users/lilac2/Box/GIEWS_Project/GIEWS/Final/Output/OLSprobitreturns_",format(Sys.Date(),"%d_%m_%y"),".tex"),include.rownames=FALSE)

t_fe=xtable(table_fe,type="latex",auto=TRUE)
names(t_fe)<-c("Country","Harvest price z-score (OLS)","R squared","Harvest price z-score (probit)","Pseudo-R squared")
print(t_fe,file=paste0("c:/Users/lilac2/Box/GIEWS_Project/GIEWS/Final/Output/OLSprobitreturns_FE",format(Sys.Date(),"%d_%m_%y"),".tex"),include.rownames=FALSE)


rm(cmat,cprep,cprep_fe,df,m,prep,results,table,table_fe,split.df,c,cstars,n,names,o,table,t,t_fe,r,v,p,i,coef,cname,pm,s,list=ls(pattern="pool"))
rm(list=ls(pattern="_o"))
rm(list=ls(pattern="_p"))


```



12.Analysis and output: Risk premium/certainty equivalent over seasonal returns
```{r risk12, echo=FALSE}


#distribution of number of years for primary maize season
n_yrs=season%>%
  filter(market_type=="Retail"& is.finite(returns1))%>%
  group_by(country,market)%>%
  dplyr::summarise(n_yrs=n())

#506 retail markets

summary(n_yrs$n_yrs)
#range: 5-21, median 9, IQR 6-13



#create data frame with prices and returns for primary maize retail season, then calculate mean and variance for prices and returns and the minimum risk coefficient to avoid storage for that harvest price
ex_price=season%>%
  filter(market_type=="Retail"& !is.na(returns1))%>%
  mutate(return=returns1,pl=lmax1,ph=hmin1)%>%
  group_by(country,region,market)%>%
  arrange(country,region,market)%>%
  dplyr::mutate(across(c(ph,pl,return),list(e=mean,v=var),na.rm=TRUE,.names = "{.fn}.{.col}"))%>%
  ungroup()%>%
  dplyr::select(1:6,pl,e.pl,ph,v.pl,return,e.return,v.return)%>%
  mutate(minr.nostore=2*e.return/v.return)
 # mutate(minr.nostore=2*(e.pl/v.pl)*(e.pl-ph))


ex_price_c=ex_price%>%
  group_by(country)%>%
dplyr::summarise(n_mkt=length(unique(market)))


#create sequence of risk aversion coefficients between 0 and 5 
sim_rr=seq(0,5,by=0.1)

#create certainty equivalent based on risk aversion coefficients and evaluate storage choice by comparing CE to harvest price and group by risk aversion tolerance with and without credit access (5% interest), also calculate the minimum risk coefficient to opt out of storage
sim=expand_grid(ex_price,sim_rr)%>%
  mutate(ce=e.pl-((sim_rr*v.pl)/(2*e.pl)),
         cr=e.return-((sim_rr*v.return)/2))%>%
  mutate(nostore.0=if_else(ph>ce,1,0),
         nostore.r0=if_else(cr<=0,1,0),nostore.r5=if_else(cr-.05<=0,1,0))%>%
  dplyr::mutate(bin=cut(sim_rr,breaks=c(0,1,3,5),right=FALSE,labels=c("Risk Neutral R=[0,1)", "Risk Averse R=[1,3)","High Risk Aversion R=[3,5)")))

#calculate market averages for storage avoidance by risk coefficient
sim_mkt=sim%>%
   group_by(country,region,market,sim_rr)%>%
  dplyr::summarise(across(contains("nostore."),mean,na.rm=TRUE,.names = "{.col}_mkt"))%>%
  ungroup()

#calculate market averages for minimum risk coefficient to avoid storage
minr_mkt=ex_price%>%
   group_by(country,region,market)%>%
  dplyr::summarise(across(contains("minr."),mean,na.rm=TRUE,.names = "{.col}_mkt"))%>%
  ungroup()

  
#calculate country averages over market averages for storage avoidance by risk coefficients and aggregate by risk tolerance group
sim_country=sim_mkt%>%
   group_by(country,sim_rr)%>%
  dplyr::summarise(across(contains("nostore."),mean,na.rm=TRUE,.names = "{.col}_c"))%>%
  ungroup()%>%
  mutate(bin=cut(sim_rr,breaks=c(0,1,3,5),right=FALSE,labels=c("Risk Neutral R=[0,1)", "Risk Averse R=[1,3)","High Risk Aversion R=[3,5)")))%>%
  filter(!is.na(bin))%>%
  group_by(country,bin)%>%
   dplyr::summarise(across(contains("nostore."),mean,na.rm=TRUE))%>%
  ungroup()%>%
 pivot_wider(names_from =bin,values_from=c("nostore.0_mkt_c","nostore.r0_mkt_c","nostore.r5_mkt_c"))

#and for min risk coefficient
minr_country=minr_mkt%>%
   group_by(country)%>%
  dplyr::summarise(across(contains("minr."),mean,na.rm=TRUE,.names = "{.col}_c"))%>%
  ungroup()


#calculate total rows and add to dataframes
sim_tot=sim_country%>%
  dplyr::summarise(across(where(is.numeric),mean,na.rm=TRUE))%>%
  mutate(country="Total")%>%
  dplyr::select(country,everything())
 
sim_country=rbind(sim_country,sim_tot)%>%
  dplyr::mutate(across(starts_with("nostore"),~paste0(sprintf("%.1f",.*100),"%")))%>%
  left_join(ex_price_c,by=c("country"))


minr_tot=minr_country%>%
  dplyr::summarise(across(where(is.numeric),mean,na.rm=TRUE))%>%
  mutate(country="Total")%>%
  dplyr::select(country,everything())

minr_country=rbind(minr_country,minr_tot)%>%
  dplyr::mutate(across(where(is.numeric),round,2))


#separate the data frames by analysis

#storage uptake percent by risk tolerance group (lean season prices no credit/interest rate)
nostore_0=sim_country%>%
  dplyr::select(country,n_mkt,starts_with("nostore.0"))

#storage uptake percent by risk tolerance group (returns to storage no credit/interest rate)
nostore_r0=sim_country%>%
  dplyr::select(country,n_mkt,starts_with("nostore.r0"))

#storage uptake percent by risk tolerance group (returns to storage 5% interest rate)
nostore_r5=sim_country%>%
  dplyr::select(country,n_mkt,starts_with("nostore.r5"))

minr_nostore=minr_country%>%
  dplyr::select(country,starts_with("minr."))


setwd("C:/Users/lilac2/Box/GIEWS_Project/GIEWS/Final/Output")

sim_table_grp=xtable(nostore_0,auto=TRUE,type="latex")
print(sim_table_grp,file=paste0("./nostore_riskgrp_",format(Sys.Date(),"%d_%m_%y"),".tex"),include.rownames=FALSE)

sim_table_grp=xtable(nostore_r0,auto=TRUE,type="latex")
print(sim_table_grp,file=paste0("./nostore_riskgrp_r",format(Sys.Date(),"%d_%m_%y"),".tex"),include.rownames=FALSE)

sim_table_grp=xtable(nostore_r5,auto=TRUE,type="latex")
print(sim_table_grp,file=paste0("./nostore_i_riskgrp_",format(Sys.Date(),"%d_%m_%y"),".tex"),include.rownames=FALSE)

sim_table_grp=xtable(minr_nostore,auto=TRUE,type="latex")
print(sim_table_grp,file=paste0("./nostore_minr_riskgrp_",format(Sys.Date(),"%d_%m_%y"),".tex"),include.rownames=FALSE)



rm(e_price,nostore_0,nostore_5,list=ls(pattern="sim"),ex_price_c)
rm(list=ls(pattern="minr"))


```


15. Predicted lean season price and certainty equivalent/risk aversion 
```{r sdresults='asis', message = FALSE,include=FALSE}

#filter season 
presplit=season%>%
  filter(market_type=="Retail"& !is.na(returns1))

split.df=split(presplit,paste(presplit$country,presplit$region,presplit$market))

cm.name=names(split.df)
#results<-list()
table3=data.frame(country_mkt=as.character(),coef=as.numeric())

for (i in 1:length(cm.name)){
df=split.df[[i]]
cname=cm.name[[i]]
m=lm(returns1~hmin1,data=df)#predict returns

p_df=df%>%
  dplyr::select(country,region,market,cropyear,hmin1,returns1)

p_df$p_returns=predict(m,newdata=p_df)

table3=rbind(table3,p_df)

}


######Returns by country (dotplot) vs prediction


#returns to main season

ex_price=table3%>%
  arrange(country,region,market)%>%
  group_by(country,region,market)%>%
  dplyr::mutate_at("p_returns",funs(e.preturn=mean,v.preturn=var))%>%
  ungroup()

ex_price_c=ex_price%>%
  group_by(country)%>%
dplyr::summarise(n_mkt=length(unique(market)))

#create sequence of risk aversion coefficients 
sim_rr=seq(0,5,by=0.1)

#create certainty equivalent by risk aversion coefficient and evaluate storage choice
sim=expand_grid(ex_price,sim_rr)%>%
  mutate(cr=e.preturn-((sim_rr*v.preturn)/2))%>%
  mutate(nostore.r0=if_else(cr<=0,1,0),)%>%
  dplyr::mutate(bin=cut(sim_rr,breaks=c(0,1,3,5),right=FALSE,labels=c("Risk Neutral R=[0,1)", "Risk Averse R=[1,3)","High Risk Aversion R=[3,5)")))



#calculate market averages for storage avoidance by risk coefficient
sim_mkt=sim%>%
   group_by(country,region,market,sim_rr)%>%
  dplyr::summarise(across(contains("nostore."),mean,na.rm=TRUE,.names = "{.col}_mkt"))%>%
  ungroup()

  
#calculate country averages over market averages for storage avoidance by risk coefficients and aggregate by risk tolerance group
sim_country=sim_mkt%>%
   group_by(country,sim_rr)%>%
  dplyr::summarise(across(contains("nostore"),mean,na.rm=TRUE,.names = "{.col}_c"))%>%
  ungroup()%>%
  mutate(bin=cut(sim_rr,breaks=c(0,1,3,5),right=FALSE,labels=c("Risk Neutral R=[0,1)", "Risk Averse R=[1,3)","High Risk Aversion R=[3,5)")))%>%
  filter(!is.na(bin))%>%
  group_by(country,bin)%>%
   dplyr::summarise(across(contains("nostore"),mean,na.rm=TRUE))%>%
  ungroup()%>%
 pivot_wider(names_from =bin,values_from=c("nostore.r0_mkt_c"))


#calculate total rows and add to dataframes
sim_tot=sim_country%>%
  dplyr::summarise(across(where(is.numeric),mean,na.rm=TRUE))%>%
  mutate(country="Total")%>%
  dplyr::select(country,everything())
 
sim_country=rbind(sim_country,sim_tot)%>%
   dplyr::mutate(across(where(is.numeric),~paste0(sprintf("%.1f",.*100),"%")))%>%
  left_join(ex_price_c,by=c("country"))


#separate the data frames by analysis
#storage uptake percent by risk tolerance group (no credit/interest rate)
nostore_r0=sim_country%>%
  dplyr::select(country,n_mkt,everything())


table_grp=xtable(nostore_r0,auto=TRUE,type="latex")
print(table_grp,file=paste0("c:/Users/lilac2/Box/GIEWS_Project/GIEWS/Final/Output/nostore_pred",format(Sys.Date(),"%d_%m_%y"),".tex"),include.rownames=FALSE)


rm(ex_price,m,p_df,p_risk1,table_grp,table3,i,rr,cname,country.name,split.df,nostore_0,df)
rm(list=ls(pattern="sim"))


```



Appendix

A1.Box and dotplots for intratemporal returns
```{r durationA1,echo=FALSE}

setwd("C:/Users/lilac2/Box/GIEWS_Project/GIEWS/Final/Output")

#want to use same set of markets as in season_mkt, but only the retail markets (506)
mlist=unlist(season_mkt%>%filter(market_type=="Retail"&n.yrs1>0)%>%distinct(country,region,commodity,market_type,market)%>%unite("z",1:5,sep="_"))

## Duration (FULL SET) data set for primary maize season
duration1=returns_dur1%>%
  unite("z",country,region,commodity,market_type,market,sep="_")%>%
  filter(z%in%mlist)%>%
  separate(z,c("country","region","commodity","market_type","market"),sep="_")%>%
  filter(market_type=="Retail"&is.finite(returns1))

#Duration (MARKET LEVEL)
duration1_mkt=duration1%>%
  group_by(country,region,commodity,market_type,market,duration1)%>%
  dplyr::summarise(returns_m=mean(returns1),
                   n_season=n(),n_neg=sum(noarb1))%>%
  ungroup()%>%
  mutate(pct_season=n_neg/n_season)%>%
  dplyr::select(-n_neg)


######Returns to duration by country (dotplot)
f_grid_dur_dot=ggplot()+geom_jitter(data=duration1,aes(x=factor(duration1),y=returns1*100,color=factor(noarb1)),size=1)+scale_y_continuous(name="Returns to storage (%)", limits=c(-100,500),breaks=seq(-100,500,100))+xlab("Number of Months Post-Harvest")+
  scale_color_manual(name="Returns",breaks=c("0","1"),values=c("red","black"),labels=c("Negative Returns","Positive Returns"))+
  facet_wrap(.~country,ncol=4,scale="free_x")+labs(title="Intratemporal returns to storage")+
  theme(legend.position = c(0.9, 0),legend.justification = c(1, 0),plot.title = element_text(hjust = 0.5,face="bold"))

#print(f_grid_dur_dot)
ggsave("dur_returns_facet_dot.PNG",width=12,height=9)

######Returns to duration by country (boxplot)
f_grid_dur_box=ggplot()+geom_boxplot(data=duration1,aes(x=factor(duration1),y=returns1*100),outlier.shape=1,position="dodge")+scale_y_continuous(name="Returns to storage (%)", limits=c(-100,500),breaks=seq(-100,500,100))+xlab("Number of Months Post-Harvest")+geom_hline(yintercept=0,color="red",position="identity")+
  facet_wrap(.~country,ncol=4,scale="free_x")+
  #labs(title="Intratemporal returns to storage (primary maize season)")+
  theme(legend.position = c(0.9, 0),legend.justification = c(1, 0),plot.title = element_text(hjust = 0.5,face="bold"),plot.margin=margin(-0.5,-0.5,-0.5,-0.5,"pt"), panel.margin = unit(0.5,"cm"))

#print(f_grid_dur_box)
ggsave("dur_returns_facet_box.PNG",width=12,height=9)

rm(f_grid_dur_dot,f_grid_dur_box)




```



A2. Certainty equivalent over all length of time
```{r duration2,echo=FALSE,results='asis', message = FALSE}

setwd("C:/Users/lilac2/Box/GIEWS_Project/GIEWS/Final/Output")

#create data frame with prices and returns for primary maize retail season, then calculate mean and variance for prices and returns and the minimum risk coefficient to avoid storage for that harvest price
ex_priced=duration1%>%
  mutate(return=returns1,pl=price_real,ph=hend1)%>%
  group_by(country,region,market,duration1)%>%
  arrange(country,region,market,duration1)%>%
  dplyr::mutate(across(c(ph,pl,return),list(e=mean,v=var),na.rm=TRUE,.names = "{.fn}.{.col}"))%>%
  ungroup()%>%
  dplyr::select(1:6,duration1,pl,e.pl,ph,v.pl,return,e.return,v.return)


ex_price_cd=ex_priced%>%
  group_by(country,duration1)%>%
dplyr::summarise(n_mkt=length(unique(market)))


#create sequence of risk aversion coefficients between 0 and 5 
sim_rr=seq(0,5,by=0.1)

#create certainty equivalent based on risk aversion coefficients and evaluate storage choice by comparing CE to harvest price and group by risk aversion tolerance with and without credit access (5% interest), also calculate the minimum risk coefficient to opt out of storage
sim=expand_grid(ex_priced,sim_rr)%>%
  mutate(cr=e.return-((sim_rr*v.return)/2))%>%
  mutate(nostore.r0=if_else(cr<=0,1,0))%>%
  dplyr::mutate(bin=cut(sim_rr,breaks=c(0,1,3,5),right=FALSE,labels=c("Risk Neutral R=[0,1)", "Risk Averse R=[1,3)","High Risk Aversion R=[3,5)")))


#calculate market averages for storage avoidance by risk coefficient
sim_mkt=sim%>%
   group_by(country,region,market,duration1,sim_rr)%>%
  dplyr::summarise(across(contains("nostore."),mean,na.rm=TRUE,.names = "{.col}_mkt"))%>%
  ungroup()

  
#calculate country averages over market averages for storage avoidance by risk coefficients and aggregate by risk tolerance group
sim_country=sim_mkt%>%
   group_by(country,duration1,sim_rr)%>%
  dplyr::summarise(across(contains("nostore."),mean,na.rm=TRUE,.names = "{.col}_c"))%>%
  ungroup()%>%
  mutate(bin=cut(sim_rr,breaks=c(0,1,3,5),right=FALSE,labels=c("Risk Neutral R=[0,1)", "Risk Averse R=[1,3)","High Risk Aversion R=[3,5)")))%>%
  filter(!is.na(bin))%>%
  group_by(country,duration1,bin)%>%
   dplyr::summarise(across(contains("nostore."),mean,na.rm=TRUE))%>%
  ungroup()




duration_risk=ggplot()+
  geom_path(data=sim_country,aes(x=factor(duration1),y=nostore.r0_mkt_c*100,color=bin,group=bin),size=1)+
  scale_colour_manual(values = c("green", "gray", "red"),name="Relative Risk Aversion")+
  scale_x_discrete(name="Number of Months Post-Harvest")+
  scale_y_continuous(name="Share of markets farmers should forgo storage",limits=c(0,100))+
  facet_wrap(.~country,ncol=4,scale="free_x")+
  #labs(title="Share of markets farmers should forgo storage over all months post-harvest")+
  theme(panel.grid.minor = element_blank(),panel.background = element_blank(),panel.grid.major = element_blank(),
         axis.line = element_line(color="black"),
         legend.position = c(0.9, 0),legend.justification = c(1, 0),
        plot.title = element_text(hjust = 0.5,face="bold"),
        plot.margin=margin(-0.5,-0.5,-0.5,-0.5,"pt"), panel.margin = unit(0.5,"cm"),
        text= element_text(family="serif"))


ggsave("duration_risk.PNG",width=12,height=9)


```




A2. Monthly Average Graphs by Country and Market
```{r monthly average}

setwd("C:/Users/lilac2/Box/GIEWS_Project/GIEWS/Final/Output")


maize_monavg = maize%>%
  unite("z",country,region,commodity,market_type,market,sep="_")%>%
  filter(z%in%mlist)%>%
  separate(z,c("country","region","commodity","market_type","market"),sep="_")%>%
  group_by(country,region,commodity,market_type,market,month)%>%
  dplyr::summarise(month_avg_real=mean(price_real,na.rm=TRUE))

c_seasons=unique(maize_monavg[,c('country')])%>%
  inner_join(seasons,by="country")%>%
  mutate(harvest_start=if_else(country=="Democratic Republic of the Congo",0,
                 if_else(country=="Tanzania",5,main_harvest_start)),
              harvest_end=if_else(country=="Democratic Republic of the Congo",2,
                 if_else(country=="Tanzania",7,main_harvest_end)),
               planting_start=if_else(country=="Democratic Republic of the Congo",6,
                 if_else(country=="Tanzania",1,main_plant_start)),
              planting_end=if_else(country=="Democratic Republic of the Congo",10,
                 if_else(country=="Tanzania",3,main_plant_end)))%>%
  group_by(country)%>%
slice(1)%>%
  ungroup()

monavg_facet=ggplot()+
  geom_rect(data=c_seasons,mapping=aes(xmin=planting_start,xmax=planting_end,ymin=-Inf,ymax=Inf,fill="gray90"),
                 color="black",alpha=0.5,show.legend=FALSE)+
       geom_rect(data=c_seasons,mapping=aes(xmin=harvest_start,xmax=harvest_end,ymin=-Inf,ymax=Inf,fill="grey50"),
                 color="black",alpha=0.5,show.legend=FALSE)+
  scale_fill_manual(values=c("gray90","grey50"))+
  geom_text(data=c_seasons,aes(x=planting_start+0.7,y=0,label="Planting1"),size=3)+
    geom_text(data=c_seasons,aes(x=harvest_start+0.7,y=0,label="Harvest1"),size=3)+
  new_scale_fill()+
  #   geom_rect(data=c_seasons,mapping=aes(xmin=second_plant_start,xmax=second_plant_end,ymin=-Inf,ymax=Inf,fill="burlywood2"),
  #             color="black",alpha=0.2,show.legend=FALSE)+
  #     geom_rect(data=c_seasons,mapping=aes(xmin=second_harvest_start,xmax=second_harvest_end,ymin=-Inf,ymax=Inf,fill="thistle"),
  #               color="black",alpha=0.2,show.legend=FALSE)+
  #  scale_fill_manual(values=c("burlywood2","thistle"))+
  # geom_text(data=c_seasons,aes(x=second_plant_start+0.7,y=4,label="Planting2"),size=3,position=position_stack(vjust=1))+
  #   geom_text(data=c_seasons,aes(x=second_harvest_start+0.7,y=4,label="Harvest2"),size=3,position=position_stack(vjust=1))+
   geom_line(data=maize_monavg, aes(x=month,y=month_avg_real,group=market,color=market),show.legend=FALSE)+
            labs(x="Month",y="Mean Local Value of Maize per Kilo (Real)") +
    scale_x_discrete(name="Month",limits=c("1","2","3","4","5","6","7","8","9","10","11","12"))+
  facet_wrap(.~country,scales="free_y",ncol=4)+
  #labs(title="Monthly Average Retail Market Maize Prices for Primary Season")+
    theme(panel.grid.minor = element_blank(),panel.background = element_blank(),
         axis.line = element_line(color="black"), strip.background = element_rect(color="black",fill="white"))

#need to note weird shit with DRC seasons because of multi-region

ggsave("monavg_facet.PNG",width=12,height=9)


```



A3. Minmax Graphs by Country
```{r monthly average}

setwd("C:/Users/lilac2/Box/GIEWS_Project/GIEWS/Final/Output")


maize_minmax=maize%>%
  unite("z",country,region,commodity,market_type,market,sep="_")%>%
  filter(z%in%mlist)%>%
  separate(z,c("country","region","commodity","market_type","market"),sep="_")%>%
   dplyr::group_by(country,region,market,commodity,market_type,year)%>%
  dplyr::summarise(min_price=min(price_real),max_price=max(price_real),
                   min_month=month[which.min(price_real)],max_month=month[which.max(price_real)])%>%
  pivot_longer(cols=min_price:max_month,names_to=c("variable",".value"),names_sep="_",values_drop_na=TRUE)


minmax_facet=ggplot()+
   geom_rect(data=c_seasons,mapping=aes(xmin=planting_start,xmax=planting_end,ymin=-Inf,ymax=Inf,fill="gray90"),
                 color="black",alpha=0.5,show.legend=FALSE)+
       geom_rect(data=c_seasons,mapping=aes(xmin=harvest_start,xmax=harvest_end,ymin=-Inf,ymax=Inf,fill="grey50"),
                 color="black",alpha=0.5,show.legend=FALSE)+
  scale_fill_manual(values=c("gray90","grey50"))+
  geom_text(data=c_seasons,aes(x=planting_start+0.7,y=100,label="Planting1"),size=3)+
    geom_text(data=c_seasons,aes(x=harvest_start+0.7,y=100,label="Harvest1"),size=3)+
  new_scale_fill()+
  geom_histogram(data=maize_minmax,aes(x=month,fill=variable,color=variable),binwidth=0.5,position="dodge") +
 scale_color_manual(name="Month Type",values=c("turquoise","navyblue"),breaks=c("min","max"),labels=c("Min price","Max price"))+
scale_fill_manual(name="Month Type",values=c("turquoise","navyblue"),breaks=c("min","max"),labels=c("Min price","Max price"))+
  scale_x_discrete(name="Month",limits=c("1","2","3","4","5","6","7","8","9","10","11","12"),expand=c(0,0))+ 
   scale_y_continuous(name="Number of Months",expand=c(0,5))+
 facet_wrap(.~country,scales="free_y",ncol=4)+
  #labs(title="Months of Minimum and Maximum Retail Market Maize Prices for Primary Season")+
    theme(panel.grid.minor = element_blank(),panel.background = element_blank(),
         axis.line = element_line(color="black"), strip.background = element_rect(color="black",fill="gray"))


ggsave("minmax_facet.PNG",width=12,height=9)


```



A4. Output: Percent Difference in Price by Country 
```{r pdiff graphs,echo=FALSE,warning=FALSE,eval=TRUE,paged.print=TRUE}

setwd("C:/Users/lilac2/Box/GIEWS_Project/GIEWS/Final/Output")


maize_pdiff=extreme1%>%
   dplyr::select(country,region,commodity,market_type,market,cropyear,returns1,hmin1,noarb1)%>%
  mutate(returns1_pct=returns1*100)

pdiff_facet=ggplot() +
    geom_point(data=maize_pdiff,aes(x=hmin1,y=returns1_pct,color=factor(noarb1)),alpha=0.5,size=1) +
 scale_y_continuous(name="Returns to storage for primary maize season (%)",limits=c(-100,500),breaks=seq(-100,500,100),expand=c(0,0)) + 
  scale_x_continuous(name="Harvest season price")+
  scale_color_manual(values=c("black","red"),breaks=c("0","1"),labels=c("Positive Returns","Negative Returns"),name="Returns to Storage")+
    facet_wrap(.~country,scales="free_x",ncol=4)+
   theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(),legend.position = c(0.65,0.1),
      panel.background = element_blank(),axis.line = element_line(color="black"))

 


ggsave("pctdiff_facet.PNG",width=12,height=9)

   
```



