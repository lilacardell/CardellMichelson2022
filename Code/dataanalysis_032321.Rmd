---
title: "Data Analysis"
author: "Lila Cardell"
date: "03/06/2021"
output: html_document
---


Load packages
```{r setup, echo=FALSE,warning=FALSE}
knitr::opts_chunk$set(
	message = FALSE,
	warning = FALSE,
	include = FALSE,
	root.dir = "C:/Users/lilac2/Box/GIEWS_Project/GIEWS/R"
)
options(scipen=999,warn=-1)
set.seed(101484)
###  Check for and load Packages   ###
#writeLines('PATH="${RTOOLS40_HOME}\\usr\\bin;${PATH}"', con = "~/.Renviron")

## Clear worksace
rm(list = ls())
gc()

## This function will check if a package is installed, and if not, install it
pkgTest  =  function(x) {
  if (!require(x, character.only = TRUE))
  {
    install.packages(x, dep = TRUE)
    if(!require(x, character.only = TRUE)) stop("Package not found")
  }
}

## These lines load the required packages
packages  =  c('data.table','tidyverse','haven','foreign','stargazer','lubridate','knitr','xtable','tables','kableExtra','car','stringr','styler','readxl','magrittr','sjmisc','ggplot2','ggpubr','ggnewscale','bookdown','scales','quantmod','distr6','plyr','esquisse','forcats','ggrepel','gdata','stringdist','SparseM','quantreg','mfx','erer','margins','moments',"lemon",'rnaturalearth','DescTools','tseries','blorr')
## you can add more packages here

lapply(packages, pkgTest)

rm(packages,pkgTest)

```


0. Import dataset
```{r import0,echo=FALSE}

setwd("c:/Users/lilac2/Box/GIEWS_Project/GIEWS/Final")

maize_prices<-read_dta("./Data/maizeprices_060321.dta")


```


1. Assign planting and harvest season months
```{r assign1,echo=FALSE}

#Reminder: note h1x,h2x,p1x,p2x if planting or harvest seasons that cross the end of the year, e.g. harvest starts in Dec and ends in Jan 
maize<-maize_prices%>%
   filter(!is.na(price_real))%>% #mostly 2020 data and Somalia which is missing CPI data
filter(!(market=="Kirundo"&year==2015&month==1&commodity=="Maize (white) - Retail"))%>% #errors in WFP dataset
filter(!(market=="Dar Es Salaam"&year==2009&month==7&commodity=="Maize - Wholesale"))%>%
   mutate(endharvest1=if_else(month==main_harvest_end,main_harvest_end,as.numeric(NA)),
          endharvest2=if_else(month==second_harvest_end,second_harvest_end,as.numeric(NA)),
          yyyymm=paste(year,formatC(month,width=2,flag="0"),sep="-"))%>%
  mutate(monthtype1=if_else(note_p1x==0&month>=main_plant_start & month<=main_plant_end,paste0("planting1_",year),#for nonwrapped planting season
                          if_else(note_p1x==1&month>=main_plant_start,paste0("planting1_",year), #for months at the end of the year
                          if_else(note_p1x==1&month<=main_plant_end,paste0("planting1_",year-1), #assume months at the beginning of the year belong with prior year's planting season
                    if_else(note_h1x==0&month>=main_harvest_start & month<=main_harvest_end,paste0("harvest1_",year),#for nonwrapped harvest season
                            if_else(note_h1x==1&month>=main_harvest_start,paste0("harvest1_",year), #for months at the end of the year
                               if_else(note_h1x==1&month<=main_harvest_end,paste0("harvest1_",year-1),"")))))),#assume months at the beginning of the year belong with prior year's harvest season
      monthtype2=if_else(note_p2x==0&month>=second_plant_start & month<=second_plant_end,paste0("planting2_",year), #for nonwrapped planting season
                               if_else(note_p2x==1&month>=second_plant_start,paste0("planting2_",year), #for months at the end of the year
                               if_else(note_p2x==1&month<=second_plant_end,paste0("planting2_",year-1), #for months at the beginning of the year
                       if_else(note_h2x==0&month>=second_harvest_start & month<=second_harvest_end,paste0("harvest2_",year),#for nonwrapped harvest season
                               if_else(note_h2x==1&month>=second_harvest_start,paste0("harvest2_",year), #for months at the end of the year
                               if_else(note_h2x==1&month<=second_harvest_end,paste0("harvest2_",year-1),"")))))))%>% #for months at the beginning of the year
separate(commodity,c("commodity","market_type"), " - ")%>%
   mutate(date=parse_date_time(yyyymm,"ym"))%>%
  dplyr::select(country,region,market,lat,lon,commodity,market_type,currency,year,month,price_real,yield_kgha,monthtype1,monthtype2,note_1,note_2,endharvest1,endharvest2,date)
 
yield=maize%>%
  dplyr::select(country,year,yield_kgha)%>%
  group_by(country,year)%>%
  slice(1)%>%
  ungroup()


```


2. Calculate returns using harvest end/min and max planting
```{r returns2,echo=FALSE}

#Note_1/2==1 means main/second planting season occurs before main/second harvest season in a calendar year,as analysis is harvest==>planting/lean, so shift planting season crop year -1 

con1 = maize%>% 
   separate(monthtype1,c("monthtype1","cropyear"),"_")%>%
  mutate(cropyear=as.numeric(cropyear))%>%
  filter(!is.na(cropyear))%>% #find all the planting or harvest months for the main season
  arrange(country,region,commodity,market_type,market,year,month)%>% 
  group_by(country,region,commodity,market_type,market,cropyear,monthtype1)%>% #group by crop year to find the price within harvest/planting months for that crop year
  dplyr::summarise(minprice=min(price_real,na.rm=TRUE),maxprice=max(price_real,na.rm=TRUE),
                   endprice=last(price_real,na.rm=TRUE),note_1=mean(note_1))%>%    
  ungroup()%>%
    mutate(cropyear=if_else(note_1==1 & monthtype1=="planting1",cropyear-1,cropyear))%>% #shift planting season back for crossed crop years so that returns are from harvest to subsequent planting season
    unite("temp",c("country","region","market","commodity","market_type"),sep="_")%>%
  pivot_wider(names_from = monthtype1,values_from=c("minprice","maxprice","endprice"))%>%
  dplyr::rename(hmin1=minprice_harvest1,hend1=endprice_harvest1,
                pmax1=maxprice_planting1)%>%
  dplyr::select(temp,cropyear,hmin1,hend1,pmax1)%>%
  mutate(returns1_c=(pmax1-hmin1)/hmin1,returns1=(pmax1-hend1)/hend1,
         noarb1_c=if_else(pmax1<=hmin1,1,0),noarb1=if_else(pmax1<=hend1,1,0))%>% #calculate returns from last harvest month and minimum harvest price
  filter(!is.na(returns1))

#~7500 observations

#repeat for second maize season
con2 = maize%>% 
   separate(monthtype2,c("monthtype2","cropyear"),"_")%>%
  mutate(cropyear=as.numeric(cropyear))%>%
  filter(!is.na(cropyear))%>% #find all the planting or harvest months for the second season
  arrange(country,region,commodity,market_type,market,year,month)%>% 
  group_by(country,region,commodity,market_type,market,cropyear,monthtype2)%>% #group by crop year to find the price within harvest/planting months for that crop year
  dplyr::summarise(minprice=min(price_real,na.rm=TRUE),maxprice=max(price_real,na.rm=TRUE),
                   endprice=last(price_real,na.rm=TRUE),note_2=mean(note_2))%>%    
  ungroup()%>%
    mutate(cropyear=if_else(note_2==1 & monthtype2=="planting2",cropyear-1,cropyear))%>% #shift planting season back for crossed crop years so that returns are from harvest to subsequent planting season
  unite("temp",c("country","region","market","commodity","market_type"),sep="_")%>%
  pivot_wider(names_from = monthtype2,values_from=c("minprice","maxprice","endprice"))%>%
  dplyr::rename(hmin2=minprice_harvest2,hend2=endprice_harvest2,
                pmax2=maxprice_planting2)%>%
  dplyr::select(temp,cropyear,hmin2,hend2,pmax2)%>%
  mutate(returns2_c=(pmax2-hmin2)/hmin2,returns2=(pmax2-hend2)/hend2,
         noarb2_c=if_else(pmax2<=hmin2,1,0),noarb2=if_else(pmax2<=hend2,1,0))%>% #calculate returns from last harvest month and minimum harvest price
  filter(!is.na(returns2))

#~2000 observations

returns_con=full_join(con1,con2,by=c("temp","cropyear"))%>%
  separate("temp",c("country","region","market","commodity","market_type"),sep="_")%>%
  arrange(country,region,market,commodity,market_type,cropyear)%>%
  left_join(yield,by=c("country","cropyear"="year"))


rm(con1,con2,yield)

```




3. Calculate intratemporal returns by varying the number of months after harvest end
```{r harvest.calc,echo=FALSE,include=FALSE}

#isolate the month of harvest end for the main season and determine the price decile for the country and market type
hend1=maize%>%
  filter(is.finite(endharvest1))%>%
  mutate(hend_date1=date,hend_price1=price_real)%>%
  dplyr::select(country,region,market,commodity,market_type,contains("hend"))%>%
  group_by(country,market_type)%>%
  dplyr::mutate(z_h1=scale(hend_price1),h1_d=as.factor(paste0("d",ntile(hend_price1,10))),h1_q=paste0("q",ntile(hend_price1,5)))%>%
  ungroup()

decile=c("d1","d2","d3","d4","d5","d6","d7","d8","d9","d10")
hend1$h1_d<-reorder.factor(hend1$h1_d,new.order=decile)

#isolate the month of harvest end for the second season and determine the price quintile for the country and market type
hend2=maize%>%
  filter(is.finite(endharvest2))%>%
  mutate(hend_date2=date,hend_price2=price_real)%>%
  dplyr::select(country,region,market,commodity,market_type,contains("hend"))%>%
  group_by(country,market_type)%>%
  dplyr::mutate(z_h2=scale(hend_price2),h2_d=as.factor(paste0("d",ntile(hend_price2,10))),h2_q=paste0("q",ntile(hend_price2,5)))%>%
  ungroup()

hend2$h2_d<-reorder.factor(hend2$h2_d,new.order=decile)

#rejoin the harvest month end and calculate returns for every month from the harvest end, keeping only the months within a year after harvest, and calculate returns
returns_dur1=maize%>%  
  left_join(hend1,by=c("country","region","market","commodity","market_type"))%>%
  mutate(duration1=interval(hend_date1,date),returns1=(price_real-hend_price1)/hend_price1,arb1=if_else(price_real>hend_price1,1,0))%>%
  mutate(duration1=duration1%/%months(1),noarb1=if_else(arb1==0,1,0))%>%
  filter(duration1%in%1:12)%>%
  dplyr::select(-lat,-lon,-currency,-note_1,-note_2,-endharvest1,-endharvest2,-monthtype1,-monthtype2)

#repeat for second season
returns_dur2=maize%>%
  left_join(hend2,by=c("country","region","market","commodity","market_type"))%>%
    mutate(duration2=interval(hend_date2,date),returns2=(price_real-hend_price2)/hend_price2,arb2=if_else(price_real>hend_price2,1,0))%>%
  mutate(duration2=duration2%/%months(1),noarb2=if_else(arb2==0,1,0))%>%
filter(duration2%in%1:12)%>%
  dplyr::select(-lat,-lon,-currency,-note_1,-note_2,-endharvest1,-endharvest2,-monthtype1,-monthtype2)

#rejoin the returns 
returns_dur=full_join(returns_dur1,returns_dur2,by=c("country","region","market","commodity","market_type","year","month","price_real","yield_kgha","date"))%>%
  arrange(country,region,market,commodity,year,month)

rm(hend1,hend2,returns_dur1,returns_dur2)

```


4. Map of markets
```{r map4,echo=FALSE}

setwd("C:/Users/lilac2/Box/GIEWS_Project/GIEWS/Final/Output/")

markets=maize%>%
  dplyr::select(country,market,market_type,lat,lon)%>%
   mutate(country=revalue(country,c("DR Congo"="Democratic Republic of the Congo","CAR"="Central African Republic")))

countries=markets%>%
  group_by(country)%>%
  dplyr::summarise(across(lat:lon,mean))


world <- ne_countries(scale = "medium", returnclass = "sf")

ggplot(data = world) +
    geom_sf(fill="antiquewhite") +
    geom_point(data=markets, aes(x = lon, y = lat,fill=market_type), size = 1, 
        shape = 23)+
   geom_label_repel(data = countries, aes(x=lon,y=lat, label = country), size =2,nudge_x= 0.15,
    direction    = "y",
    segment.size = 0.2)+
    coord_sf(xlim = c(-20,50), ylim = c(-35, 25), expand = FALSE)+
  theme(panel.grid.major = element_line(color = gray(0.5), linetype = "dashed", 
        size = 0.25), panel.background = element_rect(fill = "aliceblue"),
        legend.position=c(0.35,0.35),legend.background = element_rect(fill="aliceblue"),legend.title=element_blank(),
        axis.text.x=element_blank(),axis.ticks.x=element_blank(),axis.title.x=element_blank(),
        axis.text.y=element_blank(),axis.ticks.y=element_blank(),axis.title.y=element_blank())


ggsave("market_map.PNG",width=12,height=9)

rm(markets,countries,world)

```


5. Create summary data sets
```{r summary5,echo=FALSE}


## Duration (FULL SET) data set for primary maize season, keep markets with at least TWO years of data for each duration and countries with at least THREE markets for each commodity type
duration1=returns_dur%>%
  filter(is.finite(returns1))%>%
  group_by(country,commodity,market_type,market,duration1)%>%
  filter(n()>1)%>%#Mauritania drops out
  ungroup()%>%
  group_by(country,commodity,market_type,duration1)%>%
  filter(length(unique(market))>2)%>% 
  ungroup()

#Duration (MARKET LEVEL)
duration1_mkt=duration1%>%
  group_by(country,region,commodity,market_type,market,duration1)%>%
  dplyr::summarise(returns_m=mean(returns1),
                   n_season=n(),n_neg=sum(noarb1))%>%
  ungroup()%>%
  mutate(pct_season=n_neg/n_season)%>%
  dplyr::select(-n_neg)


## Seasonal returns for primary and second maize season data set, keep markets with at least TWO crop years and countries with at leastTHREE markets
season1=returns_con%>%
   filter(is.finite(returns1))%>%
  group_by(country,commodity,market_type,market)%>%
  filter(n()>1)%>%#Mauritania drops out
  ungroup()%>%
  group_by(country,commodity,market_type)%>%
  filter(length(unique(market))>2)%>% 
  ungroup()%>%
  dplyr::select(1:6,hmin1,pmax1,returns1,returns1_c,noarb1,noarb1_c,yield_kgha)
  

season2=returns_con%>%
   filter(is.finite(returns2))%>%
  group_by(country,commodity,market_type,market)%>%
  filter(n()>1)%>%#Mauritania drops out
  ungroup()%>%
  group_by(country,market_type)%>%
  filter(length(unique(market))>2)%>%
  ungroup()%>%
  dplyr::select(1:6,hmin2,pmax2,returns2,returns2_c,noarb2,noarb2_c,yield_kgha)

season=season1%>%
  full_join(season2,by=c("country","region","commodity","market","market_type","yield_kgha","cropyear"))



#Seasonal returns (MARKET LEVEL)
season_mkt=season%>%
  group_by(country,region,commodity,market_type,market)%>%
  dplyr::summarise(across(starts_with("returns"),list(e=mean),na.rm=TRUE,.names = "{.fn}.{.col}"),
                  across(starts_with("noarb"),~sum(.x,na.rm=TRUE),.names = "n_season_{.col}"),
                  n.yrs1=length(cropyear[is.finite(returns1)]),n.yrs2=length(cropyear[is.finite(returns2)]))%>%
  ungroup()%>%
  mutate(pct_season1=n_season_noarb1/n.yrs1,pct_season1_c=n_season_noarb1_c/n.yrs1,
         pct_season2=n_season_noarb2/n.yrs2,pct_season2_c=n_season_noarb2_c/n.yrs2)%>%
 dplyr::select(-contains("n_"))

#%>%dplyr::rename(n_season=n.returns1)

#967 markets 
pctp=function(x){
  y=mean(x[x>0],na.rm=TRUE)
}

pctn=function(x){
  y=mean(x[x<=0],na.rm=TRUE)
}

#Seasonal returns (COUNTRYLEVEL)
season_country=season%>%
  group_by(country,commodity,market_type)%>%
   dplyr::summarise(across(starts_with("returns"),list(e=mean,pos=~pctp(.x),neg=~pctn(.x)),na.rm=TRUE,.names = "{.fn}.{.col}"),
                    across(starts_with("noarb"),~sum(.x,na.rm=TRUE),.names = "n_season_{.col}"),
                   n.mkt1=n_distinct(market[is.finite(returns1)]),n.mkt2=n_distinct(market[is.finite(returns2)]),
                   n.yrs1=length(market[is.finite(returns1)]),n.yrs2=length(market[is.finite(returns2)]))%>%
       ungroup()%>%
   mutate(pct_season1=n_season_noarb1/n.yrs1,pct_season1_c=n_season_noarb1_c/n.yrs1,
         pct_season2=n_season_noarb2/n.yrs2,pct_season2_c=n_season_noarb2_c/n.yrs2)%>%
  dplyr::select(-starts_with("n_"))

#make a list of years covered
all_years=season%>%
  arrange(country,market_type,cropyear)%>%
  group_by(country,market_type)%>%
  dplyr::summarise(minyr=min(cropyear),maxyr=max(cropyear))%>%
  mutate(years=paste(minyr,maxyr,sep="-"))%>%
dplyr::select(country,market_type,years)
 
#add list of years to country data
season_country=season_country%>%
  left_join(all_years,by=c("country","market_type"))%>%
  dplyr::select(country,commodity,market_type,years,contains("1"),contains("2"))


rm(all_years,season1,season2,pctn,pctp)
 
```


6. Look at measures of skewness and kurtosis in all markets
```{r skew6,echo=FALSE,include=FALSE}

clist=unique(season$country)
mlist=unique(season$market)

skew_mkt=maize%>%
  filter(country%in%clist&market%in%mlist)%>%
  group_by(country,market,market_type)%>%
  filter(n()>2)%>%
  dplyr::summarise(nobs=n(),cv=(mean(price_real)/sd(price_real)),
                   skew=skewness(price_real),kurt=kurtosis(price_real))%>%
  mutate(n_skew=if_else(skew<=0,1,0),n_kurt=if_else(kurt<=0,1,0))%>%
  ungroup()

#no evidence of negative kurtosis in any markets

skew_country=skew_mkt%>%
  group_by(country,market_type)%>%
  filter(n()>2)%>%
  dplyr::summarise(across(c(cv,kurt,skew),mean,na.rm=TRUE),across(starts_with("n"),sum,na.rm=TRUE),n_mkt=n())%>%
  dplyr::mutate(n_skew_pct=n_skew/n_mkt,n_kurt_pct=n_kurt/n_mkt)%>%
  dplyr::mutate(across(c(n_skew_pct,n_kurt_pct),~paste0(sprintf("%.1f",.*100),"%")),
            across(c(cv,skew,kurt),round,3))%>%
  ungroup()%>%
  dplyr::select(country,market_type,n_mkt,skew,n_skew_pct)


#KPSS test for stationarity
extreme1_mkt=season%>%
  filter(market_type=="Retail"&is.finite(returns1_c))%>%
  unite("c_mkt",c("country","market"))%>%
  group_by(c_mkt)%>%
  arrange(c_mkt,cropyear)%>%
  dplyr::summarise(pval=ifelse(n()<=3,as.numeric(NA),kpss.test(ts(returns1_c))$p.value))

nrow(subset(extreme1_mkt,pval<0.05))
#20 markets


print=xtable(skew_country,type="latex")
names(print)<-c("Country","Market Type","Markets","Average Market Skewness ","Percent Markets Negative Skew")
print(print,file=paste0("C:/Users/lilac2/Box/GIEWS_Project/GIEWS/Final/Output/skew_kurt_",format(Sys.Date(),"%d_%m_%y"),".tex"),include.rownames=FALSE)

rm(skew_mkt,skew_country,print)

```




7. Print summary datasets
```{r print7,echo=FALSE}

setwd("C:/Users/lilac2/Box/GIEWS_Project/GIEWS/Final/Output")

#summary datasets for main season
sum_retail1=season_country%>%
  filter(market_type=="Retail"&n.yrs1>0)%>%
  dplyr::select(country,years,contains("1"))%>%
  dplyr::summarise(across(starts_with("n."),sum),across(starts_with("pct_"),mean,na.rm=TRUE),across(contains("returns"),mean,na.rm=TRUE))%>%
                   mutate(country="Total",commodity=" ",years=" ")%>%
  dplyr::select(country,years,n.mkt1,n.yrs1,pct_season1,e.returns1,pos.returns1,neg.returns1,
                pct_season1_c,e.returns1_c,pos.returns1_c,neg.returns1_c)

sum_wholesale1=season_country%>%
  filter(market_type=="Wholesale"&n.yrs1>0)%>%
 dplyr::select(country,years,contains("1"))%>%
  dplyr::summarise(across(starts_with("n."),sum),across(starts_with("pct_"),mean,na.rm=TRUE),across(contains("returns"),mean,na.rm=TRUE))%>%
                   mutate(country="Total",commodity=" ",years=" ")%>%
  dplyr::select(country,years,n.mkt1,n.yrs1,pct_season1,e.returns1,pos.returns1,neg.returns1,
                pct_season1_c,e.returns1_c,pos.returns1_c,neg.returns1_c)

#main season (retail)
retail1=season_country%>%
  filter(market_type=="Retail"&n.yrs1>0)%>%
  dplyr::select(country,years,n.mkt1,n.yrs1,pct_season1,e.returns1,pos.returns1,neg.returns1,
                pct_season1_c,e.returns1_c,pos.returns1_c,neg.returns1_c)%>%
  rbind(sum_retail1)%>%
  dplyr::mutate(across(contains("pct"),~paste0(sprintf("%.1f",.*100),"%")),across(contains("returns"),~paste0(sprintf("%.1f",.*100),"%")),
                country=revalue(country,c("Democratic Republic of the Congo"="DR Congo","Central African Republic"="CAR")))


#main season (wholesale)
wholesale1=season_country%>%
filter(market_type=="Wholesale"&n.yrs1>0)%>%
  dplyr::select(country,years,n.mkt1,n.yrs1,pct_season1,e.returns1,pos.returns1,neg.returns1,
                pct_season1_c,e.returns1_c,pos.returns1_c,neg.returns1_c)%>%
  rbind(sum_wholesale1)%>%
  dplyr::mutate(across(contains("pct"),~paste0(sprintf("%.1f",.*100),"%")),across(contains("returns"),~paste0(sprintf("%.1f",.*100),"%")),
                country=revalue(country,c("Democratic Republic of the Congo"="DR Congo","Central African Republic"="CAR")))


#summary datasets for second season
sum_retail2=season_country%>%
  filter(market_type=="Retail"&n.yrs2>0)%>%
  dplyr::select(country,years,contains("2"))%>%
  dplyr::summarise(across(starts_with("n."),sum),across(starts_with("pct_"),mean,na.rm=TRUE),across(contains("returns"),mean,na.rm=TRUE))%>%
                   mutate(country="Total",commodity=" ",years=" ")%>%
  dplyr::select(country,years,n.mkt2,n.yrs2,pct_season2,e.returns2,pos.returns2,neg.returns2,
                pct_season2_c,e.returns2_c,pos.returns2_c,neg.returns2_c)

sum_wholesale2=season_country%>%
  filter(market_type=="Wholesale"&n.yrs2>0)%>%
 dplyr::select(country,years,contains("2"))%>%
  dplyr::summarise(across(starts_with("n."),sum),across(starts_with("pct_"),mean,na.rm=TRUE),across(contains("returns"),mean,na.rm=TRUE))%>%
                   mutate(country="Total",commodity=" ",years=" ")%>%
  dplyr::select(country,years,n.mkt2,n.yrs2,pct_season2,e.returns2,pos.returns2,neg.returns2,
                pct_season2_c,e.returns2_c,pos.returns2_c,neg.returns2_c)


#second season (retail)
retail2=season_country%>%
  filter(market_type=="Retail"&n.yrs2>0)%>%
  dplyr::select(country,years,n.mkt2,n.yrs2,pct_season2,e.returns2,pos.returns2,neg.returns2,
                pct_season2_c,e.returns2_c,pos.returns2_c,neg.returns2_c)%>%
 rbind(sum_retail2)%>%
  dplyr::mutate(across(contains("pct"),~paste0(sprintf("%.1f",.*100),"%")),across(contains("returns"),~paste0(sprintf("%.1f",.*100),"%")),
                country=revalue(country,c("Democratic Republic of the Congo"="DR Congo","Central African Republic"="CAR")))



#second season (wholesale)
wholesale2=season_country%>%
  filter(market_type=="Wholesale"&n.yrs2>0)%>%
  dplyr::select(country,years,n.mkt2,n.yrs2,pct_season2,e.returns2,pos.returns2,neg.returns2,
                pct_season2_c,e.returns2_c,pos.returns2_c,neg.returns2_c)%>%
 rbind(sum_wholesale2)%>%
  dplyr::mutate(across(contains("pct"),~paste0(sprintf("%.1f",.*100),"%")),across(contains("returns"),~paste0(sprintf("%.1f",.*100),"%")),
                country=revalue(country,c("Democratic Republic of the Congo"="DR Congo","Central African Republic"="CAR")))


# header<-c("Country","Years","Markets","Market-Years",
#                 "Frequency of Negative Returns","Average Total Returns","Average Positive Returns","Average Negative Returns",
#                 "Frequency of Negative Returns","Average Total Returns","Average Positive Returns","Average Negative Returns")

# print=xtable(retail1,type="latex")
# names(print)<-header
# print(print,file=paste0("./retailprices_main_",format(Sys.Date(),"%d_%m_%y"),".tex"),include.rownames=FALSE)
# 
# print=xtable(retail2,type="latex")
# names(print)<-header
# print(print,file=paste0("./retailprices_second_",format(Sys.Date(),"%d_%m_%y"),".tex"),include.rownames=FALSE)
# 
# print=xtable(wholesale1,type="latex")
# names(print)<-header
# print(print,file=paste0("./wholesaleprices_main_",format(Sys.Date(),"%d_%m_%y"),".tex"),include.rownames=FALSE)
# 
# 
# print=xtable(wholesale2,type="latex")
# names(print)<-header
# print(print,file=paste0("./wholesaleprices_second_",format(Sys.Date(),"%d_%m_%y"),".tex"),include.rownames=FALSE)



###go with conservative calculations
header<-c("Country","Years","Markets","Market-Years",
                "Frequency of Negative Returns","Average Total Returns","Average Positive Returns","Average Negative Returns")

retail1_c=retail1%>%
  dplyr::select(country,years,n.mkt1,n.yrs1,contains("_c"))

retail1_ltd=retail1_c%>%
  dplyr::select(country,e.returns1_c,pct_season1_c,neg.returns1_c)

print_ltd=xtable(retail1_ltd,type="latex")
names(print_ltd)<-c("Country","Average Total Returns","Frequency of Negative Returns","Average Negative Returns")
print(print_ltd,file=paste0("./retailprices_main_ltd",format(Sys.Date(),"%d_%m_%y"),".tex"),include.rownames=FALSE)

print=xtable(retail1_c,type="latex")
names(print)<-header
print(print,file=paste0("./retailprices_main_",format(Sys.Date(),"%d_%m_%y"),".tex"),include.rownames=FALSE)

retail2_c=retail2%>%
  dplyr::select(country,years,n.mkt2,n.yrs2,contains("_c"))

print=xtable(retail2_c,type="latex")
names(print)<-header
print(print,file=paste0("./retailprices_second_",format(Sys.Date(),"%d_%m_%y"),".tex"),include.rownames=FALSE)

wholesale1_c=wholesale1%>%
  dplyr::select(country,years,n.mkt1,n.yrs1,contains("_c"))

print=xtable(wholesale1_c,type="latex")
names(print)<-header
print(print,file=paste0("./wholesaleprices_main_",format(Sys.Date(),"%d_%m_%y"),".tex"),include.rownames=FALSE)



rm(list=ls(pattern="sum_"),retail1,retail2,wholesale1,wholesale2,print,header,retail1_c,retail2_c,wholesale1_c)



```


8. Output figure for paper2/3: Dot plot of frequency of negative returns vs severity of trend (average returns)
```{r output8,echo=FALSE}

setwd("C:/Users/lilac2/Box/GIEWS_Project/GIEWS/Final/Output/")

cb1=season_mkt%>%
  filter(market_type=="Retail"&is.finite(e.returns1_c))


cb1plot=ggplot()+
   geom_point(data=cb1,aes(x=pct_season1_c*100,y=e.returns1_c*100,size=n.yrs1))+ scale_y_continuous(name="Average returns to storage (%)",limits=c(-50,150),breaks=seq(-50,150,50),expand=c(0,0)) +  scale_x_continuous(name="% of seasons with negative returns",limits=c(0,100),breaks=seq(0,100,20)) + 
   theme(panel.grid.minor = element_blank(),panel.background = element_blank(),panel.grid.major = element_line(color="lightgray"),legend.position = c(1, 1),legend.justification = c(1, 1),
         axis.line = element_line(color="black"))+guides(size = guide_legend(reverse = TRUE))+
  geom_hline(yintercept=0,color="darkgray")+ scale_size(range = c(0.5,3),breaks=c(2,4,8,12,16,20),name="Number of \n market-years")

print(cb1plot)

ggsave("seasondotplot.png")

 
neg_all=cb1%>%filter(pct_season1==1) #22
pos_all=cb1%>%filter(pct_season1==0) #168
neg_country=unique(neg_all$country) #12 different countries
pos_country=unique(pos_all$country) #18 different countries
neg_market=unique(neg_all$market) #22 different markets
pos_market=unique(pos_all$market) #168 different markets
neg_all=season%>%filter(market%in%neg_market)#63 total observations for those 22 markets
pos_all=season%>%filter(market%in%pos_market)#900 total observations for those 168 markets

neg_year=unique(neg_all$cropyear) #15 different years
pos_year=unique(pos_all$cropyear) #18 different years



rm(cb1,cb1plot,list=ls(pattern="neg_")) 
rm(list=ls(pattern="pos_"))

```


9. Output figure for paper1/2/3: Boxplot of frequency of negative returns over time 
```{r output9,echo=FALSE}

setwd("C:/Users/lilac2/Box/GIEWS_Project/GIEWS/Final/Output/")


dot= ggplot()+geom_jitter(data=subset(season,market_type=="Retail"),aes(x=factor(cropyear),y=returns1_c*100,color=yield_kgha),size=1.0,alpha=0.75)+ #geom_hline(yintercept=0,color="red",position="identity")+
  scale_color_gradient2(low="gray80",high="gray10",na.value="gray",name="Yield (kg/ha)",limits=c(0,6000))+
#scale_color_gradient2(low="chartreuse",high="darkgreen",na.value="gray",name="Yield (kg/ha)",limits=c(0,4000))+
  scale_y_continuous(name="Returns to storage (%)",limits=c(-100,500),breaks=seq(-100,500,100),expand=c(0,0))+
  scale_x_discrete(name="Year",breaks=c("2000","2004","2008","2012","2016","2020"),labels=c("2000","2004","2008","2012","2016","2020"),expand=c(0,0))+
  geom_hline(yintercept=0,color="red",position="identity")+
  theme(panel.grid.major = element_line(color="lightgray"),panel.grid.minor = element_blank(), panel.background = element_blank(),axis.line = element_line(color="black"),legend.position = c(1, 1),legend.justification = c(1, 1))
  #geom_jitter(data=subset(time,dpct<=0),aes(x=year, y=dpct,color="red",size=yield_kgha),alpha=0.5)+
 #geom_jitter(data=subset(time,dpct>0),aes(x=year,y=dpct,color="black",size=yield_kgha),alpha=0.5)+
#scale_color_manual(values=c("black","red")) + 
#scale_y_continuous(name="Seasonal Returns (%)",limits=c(-100,500),breaks=seq(-100,500,100))+
  # geom_text(data=time,aes(x=2010,y=450,label="High Planting Price, Low Harvest Price",color="black"),size=4)+
   # geom_text(data=time,aes(x=2010,y=-95,label="High Harvest Price, Low Planting Price",color="red"),size=4)
print(dot)
ggsave("cropyear_returns_dot.PNG")


box= ggplot()+geom_boxplot(data=subset(season,market_type=="Retail"),aes(x=factor(cropyear),y=returns1_c*100),outlier.shape=1,position="dodge") + geom_hline(yintercept=0,color="red",position="identity")+
 scale_y_continuous(name="Returns to storage (%)", limits=c(-100,500),breaks=seq(-100,500,100))+ scale_x_discrete(name="Year",breaks=c("2000","2004","2008","2012","2016","2020"))+
    theme(panel.grid.major = element_blank(),legend.position="none",panel.grid.minor = element_blank(), panel.background = element_blank(),axis.line = element_line(color="black"))

print(box)
ggsave("cropyear_returns_box.PNG")

rm(dot,box)




```



10. Plots for distribution of extreme harvest prices and returns (for seasonal returns for primary season)
```{r output10,echo=FALSE}

setwd("C:/Users/lilac2/Box/GIEWS_Project/GIEWS/Final/Output/")

extreme1=season%>%
  filter(market_type=="Retail"&is.finite(returns1_c))%>%
  group_by(country)%>%
  dplyr::mutate(z_h1=scale(hmin1),h1_d=as.factor(paste0("d",ntile(hmin1,10))))%>%
  ungroup()

#decile=c("d1","d2","d3","d4","d5","d6","d7","d8","d9","d10")
#extreme1$h1_d<-reorder.factor(extreme1$h1_d,new.order=decile)

extremedot=ggplot()+geom_point(data=extreme1,aes(x=z_h1,y=returns1_c*100,shape=factor(noarb1_c)))+
  scale_y_continuous(name="Returns to storage for primary maize season (%)",limits=c(-100,500),breaks=seq(-100,500,100)) + 
  scale_x_continuous(name="Z-score of harvest price for primary maize season",limits=c(-3,8),breaks=seq(-3,8,1),expand=c(0,0))+
  scale_shape_manual(values=c(3,1),breaks=c("0","1"),labels=c("Positive Returns","Negative Returns"),name="Returns to Storage")+
  theme(panel.grid.minor = element_blank(),axis.line = element_line(color="black"),
        legend.position = c(0.9, 0.9),legend.justification = c(1, 1))

print(extremedot)
ggsave("harvestprices_returns.png")

rm(decile,extremedot)

```



11. OLS and probit regressions on harvest price (for primary maize retail season)
```{r OLSreg11 ,echo=FALSE}

split.df=split(extreme1,extreme1$country)
country.name=names(split.df)

#run with and without cropyear FE as robustness check
table=data.frame(country=as.character())
table_fe=data.frame(country=as.character())

for (i in 1:length(country.name)){
df=split.df[[i]]
cname=country.name[[i]]

#without FE
#OLS 
o=lm(returns1_c*100~z_h1,data=df) #without FE
s=summary(o)
coef_o=s$coefficients[1,1]
pval_o=s$coefficients[1,4]
rsq_o=s$r.squared

#probit
p=glm(factor(noarb1)~z_h1,data=df,family=binomial(link = "probit"))
pm=probitmfx(factor(noarb1)~z_h1,data=df,atmean=FALSE,robust=TRUE)
rsq_p=as.numeric(PseudoR2(p,which="McFadden"))
coef_p=pm$mfxest[1,1]
pval_p=pm$mfxest[1,4]

cprep=data.frame(cname,coef_o,pval_o,rsq_o,coef_p,pval_p,rsq_p)
table=rbind(table,cprep)

#with FE
#OLS 
o=lm(returns1_c*100~z_h1+factor(cropyear),data=df) #with FE
s=summary(o)
coef_o=s$coefficients[1,1]
pval_o=s$coefficients[1,4]
rsq_o=s$r.squared

#probit
p=glm(factor(noarb1)~z_h1+factor(cropyear),data=df,family=binomial(link = "probit"))
pm=probitmfx(factor(noarb1)~z_h1+factor(cropyear),data=df,atmean=FALSE,robust=TRUE)
rsq_p=as.numeric(PseudoR2(p,which="McFadden"))
coef_p=pm$mfxest[1,1]
pval_p=pm$mfxest[1,4]

cprep_fe=data.frame(cname,coef_o,pval_o,rsq_o,coef_p,pval_p,rsq_p)
table_fe=rbind(table_fe,cprep_fe)

}

###pooled regressions w.out cropyear FE
o_pool=lm(returns1_c*100~z_h1+factor(country),data=extreme1)
s_pool=summary(o_pool)
rsq_o_pool=s_pool$r.squared
p_pool=glm(factor(noarb1)~z_h1+factor(country),data=extreme1,family=binomial(link = "probit"))
rsq_p_pool=PseudoR2(p_pool,which="McFadden")

table=table%>%
  add_row(cname="CC Average",rsq_o=mean(table$rsq_o),rsq_p=mean(table$rsq_p))%>%
   add_row(cname="Pooled",rsq_o=rsq_o_pool,rsq_p=rsq_p_pool)%>%
  mutate(stars_o=ifelse(pval_o < .01, "***", ifelse(pval_o < .05, "** ", ifelse(pval_o < .1, "* ", " "))),
         stars_p=ifelse(pval_p < .01, "***", ifelse(pval_p < .05, "** ", ifelse(pval_p < .1, "* ", " "))))%>%
  dplyr::mutate(cp_o=paste(round(coef_o,3),stars_o,sep=""),cp_p=paste(round(coef_p,3),stars_p,sep=""),
         across(starts_with("rsq"),round,2))%>%
  dplyr::select(cname,cp_o,rsq_o,cp_p,rsq_p)

###pooled regressions w/cropyear FE
o_pool=lm(returns1_c*100~z_h1+factor(cropyear)+factor(country),data=extreme1)
s_pool=summary(o_pool)
rsq_o_pool=s_pool$r.squared
p_pool=glm(factor(noarb1)~z_h1+factor(cropyear)+factor(country),data=extreme1,family=binomial(link = "probit"))
rsq_p_pool=PseudoR2(p_pool,which="McFadden")


table_fe=table_fe%>%
  add_row(cname="CC Average",rsq_o=mean(table_fe$rsq_o),rsq_p=mean(table_fe$rsq_p))%>%
   add_row(cname="Pooled",rsq_o=rsq_o_pool,rsq_p=rsq_p_pool)%>%
  mutate(stars_o=ifelse(pval_o < .01, "***", ifelse(pval_o < .05, "** ", ifelse(pval_o < .1, "* ", " "))),
         stars_p=ifelse(pval_p < .01, "***", ifelse(pval_p < .05, "** ", ifelse(pval_p < .1, "* ", " "))))%>%
  dplyr::mutate(cp_o=paste(round(coef_o,3),stars_o,sep=""),cp_p=paste(round(coef_p,3),stars_p,sep=""),
         across(starts_with("rsq"),round,2))%>%
  dplyr::select(cname,cp_o,rsq_o,cp_p,rsq_p)


t=xtable(table,type="latex",auto=TRUE)
names(t)<-c("Country","Harvest price z-score (OLS)","R squared","Harvest price z-score (probit)","Pseudo-R squared")
print(t,file=paste0("c:/Users/lilac2/Box/GIEWS_Project/GIEWS/Final/Output/OLSprobitreturns_",format(Sys.Date(),"%d_%m_%y"),".tex"),include.rownames=FALSE)

t_fe=xtable(table_fe,type="latex",auto=TRUE)
names(t_fe)<-c("Country","Harvest price z-score (OLS)","R squared","Harvest price z-score (probit)","Pseudo-R squared")
print(t_fe,file=paste0("c:/Users/lilac2/Box/GIEWS_Project/GIEWS/Final/Output/OLSprobitreturns_FE",format(Sys.Date(),"%d_%m_%y"),".tex"),include.rownames=FALSE)


rm(cmat,cprep,cprep_fe,df,m,prep,results,table,table_fe,split.df,c,cstars,n,names,o,table,t,t_fe,r,v,p,i,coef,cname,pm,s,list=ls(pattern="pool"))
rm(list=ls(pattern="_o"))
rm(list=ls(pattern="_p"))


```



12.Analysis and output for paper v3: Risk premium/certainty equivalent over seasonal returns
```{r risk12, echo=FALSE}


#distribution of number of years for primary maize season
n_yrs=season%>%
  filter(market_type=="Retail"& !is.na(returns1_c))%>%
  group_by(country,market)%>%
  dplyr::summarise(n_yrs=n())

summary(n_yrs$n_yrs)
#range: 2-20, median 6, IQR 4-11

nrow(subset(n_yrs,n_yrs>=6)) # 437 markets left

pvar<-function(x){
  y= mean((x-mean(x))^2)
}

#create data frame with prices and returns for primary maize retail season, then calculate mean and variance for prices and returns and the minimum risk coefficient to avoid storage for that harvest price
ex_price=season%>%
  filter(market_type=="Retail"& !is.na(returns1_c))%>%
  mutate(return=returns1_c,pl=pmax1,ph=hmin1)%>%
  group_by(country,market)%>%
  filter(n()>=6)%>% #keep markets with 6 or more market years
  ungroup()%>%
  group_by(country)%>%
 filter(length(unique(market))>=3)%>% #drop 3 countries with only 1 or 2 markets
    ungroup()%>%
  group_by(country,market)%>%
  arrange(country,market)%>%
  dplyr::mutate(across(c(ph,pl,return),list(e=mean,v=var,v2=~pvar(.x)),na.rm=TRUE,.names = "{.fn}.{.col}"))%>%
  ungroup()%>%
  dplyr::select(1:6,pl,e.pl,ph,v.pl,return,e.return,v.return,v2.return)%>%
  mutate(minr.nostore=2*e.return/v.return)
 # mutate(minr.nostore=2*(e.pl/v.pl)*(e.pl-ph))


ex_price_c=ex_price%>%
  group_by(country)%>%
dplyr::summarise(n_mkt=length(unique(market)))


#create sequence of risk aversion coefficients between 0 and 5 
sim_rr=seq(0,5,by=0.1)

#create certainty equivalent based on risk aversion coefficients and evaluate storage choice by comparing CE to harvest price and group by risk aversion tolerance with and without credit access (5% interest), also calculate the minimum risk coefficient to opt out of storage
sim=expand_grid(ex_price,sim_rr)%>%
  mutate(ce=e.pl-((sim_rr*v.pl)/(2*e.pl)),
         cr=e.return-((sim_rr*v2.return)/2))%>%
  mutate(nostore.0=if_else(ph>ce,1,0),nostore.5=if_else(ph>(ce/(1+.05)),1,0),
         nostore.r0=if_else(cr<=0,1,0),nostore.r5=if_else(cr-.05<=0,1,0))%>%
  dplyr::mutate(bin=cut(sim_rr,breaks=c(0,1,3,5),right=FALSE,labels=c("Risk Neutral R=[0,1)", "Risk Averse R=[1,3)","High Risk Aversion R=[3,5)")))

#calculate market averages for storage avoidance by risk coefficient
sim_mkt=sim%>%
   group_by(country,market,sim_rr)%>%
  dplyr::summarise(across(contains("nostore."),mean,na.rm=TRUE,.names = "{.col}_mkt"))%>%
  ungroup()

#calculate market averages for minimum risk coefficient to avoid storage
minr_mkt=ex_price%>%
   group_by(country,market)%>%
  dplyr::summarise(across(contains("minr."),mean,na.rm=TRUE,.names = "{.col}_mkt"))%>%
  ungroup()

  
#calculate country averages over market averages for storage avoidance by risk coefficients and aggregate by risk tolerance group
sim_country=sim_mkt%>%
   group_by(country,sim_rr)%>%
  dplyr::summarise(across(contains("nostore."),mean,na.rm=TRUE,.names = "{.col}_c"))%>%
  ungroup()%>%
  mutate(bin=cut(sim_rr,breaks=c(0,1,3,5),right=FALSE,labels=c("Risk Neutral R=[0,1)", "Risk Averse R=[1,3)","High Risk Aversion R=[3,5)")))%>%
  filter(!is.na(bin))%>%
  group_by(country,bin)%>%
   dplyr::summarise(across(contains("nostore."),mean,na.rm=TRUE))%>%
  ungroup()%>%
 pivot_wider(names_from =bin,values_from=c("nostore.0_mkt_c","nostore.5_mkt_c","nostore.r0_mkt_c","nostore.r5_mkt_c"))

#and for min risk coefficient
minr_country=minr_mkt%>%
   group_by(country)%>%
  dplyr::summarise(across(contains("minr."),mean,na.rm=TRUE,.names = "{.col}_c"))%>%
  ungroup()


#calculate total rows and add to dataframes
sim_tot=sim_country%>%
  dplyr::summarise(across(where(is.numeric),mean,na.rm=TRUE))%>%
  mutate(country="Total")%>%
  dplyr::select(country,everything())
 
sim_country=rbind(sim_country,sim_tot)%>%
  dplyr::mutate(across(starts_with("nostore"),~paste0(sprintf("%.1f",.*100),"%")))%>%
  left_join(ex_price_c,by=c("country"))


minr_tot=minr_country%>%
  dplyr::summarise(across(where(is.numeric),mean,na.rm=TRUE))%>%
  mutate(country="Total")%>%
  dplyr::select(country,everything())

minr_country=rbind(minr_country,minr_tot)%>%
  dplyr::mutate(across(where(is.numeric),round,2))


#separate the data frames by analysis

#storage uptake percent by risk tolerance group (no credit/interest rate)
nostore_0=sim_country%>%
  dplyr::select(country,n_mkt,starts_with("nostore.0"))

#storage uptake percent by risk tolerance group (no credit/interest rate)
nostore_r0=sim_country%>%
  dplyr::select(country,n_mkt,starts_with("nostore.r0"))

#storage uptake percent by risk tolerance group (5% interest rate)
nostore_r5=sim_country%>%
  dplyr::select(country,n_mkt,starts_with("nostore.r5"))

minr_nostore=minr_country%>%
  dplyr::select(country,starts_with("minr."))


setwd("C:/Users/lilac2/Box/GIEWS_Project/GIEWS/Final/Output")

sim_table_grp=xtable(nostore_0,auto=TRUE,type="latex")
print(sim_table_grp,file=paste0("./nostore_riskgrp_",format(Sys.Date(),"%d_%m_%y"),".tex"),include.rownames=FALSE)

sim_table_grp=xtable(nostore_r0,auto=TRUE,type="latex")
print(sim_table_grp,file=paste0("./nostore_riskgrp_r",format(Sys.Date(),"%d_%m_%y"),".tex"),include.rownames=FALSE)

sim_table_grp=xtable(nostore_r5,auto=TRUE,type="latex")
print(sim_table_grp,file=paste0("./nostore_i_riskgrp_",format(Sys.Date(),"%d_%m_%y"),".tex"),include.rownames=FALSE)

sim_table_grp=xtable(minr_nostore,auto=TRUE,type="latex")
print(sim_table_grp,file=paste0("./nostore_minr_riskgrp_",format(Sys.Date(),"%d_%m_%y"),".tex"),include.rownames=FALSE)


# risk_facet_pct=ggplot()+
#   geom_bar(data=sim_country_all,aes(x=rr,y=nostore_mkt_c),stat="identity",color="gray")+
#  #scale_fill_manual(values=c("red","gray"),breaks=c("no storage","store"),labels=c("No storage","Storage"),name="Choice")+
#   #scale_color_manual(values=c("red","gray"),breaks=c("no storage","store"),labels=c("No storage","Storage"),name="Choice")+
#   scale_y_continuous(name="Storage Avoidance (%)",limits=c(0,100),breaks=seq(0,100,25),expand=c(0,0))+
#   scale_x_continuous(name="Relative Risk Aversion Coeffient",limits=c(0,5),expand=c(0,0))+
#   facet_wrap(.~country,scales="free_y",ncol=4)+labs(title="Storage Avoidance by Risk Aversion Coefficient")+
#   theme(panel.grid.minor = element_blank(),panel.background = element_blank(),panel.grid.major = element_blank(),
#          axis.line = element_line(color="black"), strip.background = element_rect(color="black",fill="white"),
#          legend.position = c(0.9, 0),legend.justification = c(1, 0),
#         plot.title = element_text(hjust = 0.5,face="bold"),
#         panel.margin = unit(1,"line"),text= element_text(family="serif"))
# ggsave("C:/Users/lilac2/Box/GIEWS_Project/GIEWS/Graphs/riskcoef_facet.PNG",width=12,height=9)

# risk_malawi_pct=ggplot()+
#   geom_bar(data=subset(sim_country,country=="Malawi"),aes(x=rr,y=nostore_mkt_c,fill=bin),stat="identity")+
#  #scale_fill_manual(values=c("red","gray"),breaks=c("no storage","store"),labels=c("No storage","Storage"),name="Choice")+
#   scale_fill_manual(values=c("blue","gray","red"),breaks=c("Risk Neutral R=[0,1)", "Risk Averse R=[1,3)","High Risk Aversion R=[3,5)"),labels=c("Risk Neutral R=[0,1)", "Risk Averse R=[1,3)","High Risk Aversion R=[3,5)"),name="Risk Tolerance",na.translate=FALSE)+
#   scale_y_continuous(name="Storage Avoidance (%)",limits=c(0,100),breaks=seq(0,100,25),expand=c(0,0))+
#   scale_x_continuous(name="Relative Risk Aversion Coeffient",limits=c(0,5),expand=c(0,0))+
#   facet_wrap(.~country,scales="free_y",ncol=4)+labs(title="Storage Avoidance by Risk Aversion Coefficient")+
#   theme(panel.grid.minor = element_blank(),panel.background = element_blank(),panel.grid.major = element_blank(),
#          axis.line = element_line(color="black"), strip.background = element_rect(color="black",fill="white"),
#          legend.position = c(0.75, 0.75),legend.justification = c(1, 0),
#         plot.title = element_text(hjust = 0.5,face="bold"),
#         panel.margin = unit(1,"line"),text= element_text(family="serif"))
# ggsave("C:/Users/lilac2/Box/GIEWS_Project/GIEWS/Graphs/riskcoef_malawi.PNG",width=12,height=9)


rm(e_price,nostore_0,nostore_5,list=ls(pattern="sim"),ex_price_c)
rm(list=ls(pattern="minr"))


```


15. Predicted lean season price and certainty equivalent/risk aversion (drop)
```{r sdresults='asis', message = FALSE,include=FALSE}

#filter season for 431 markets
presplit=season%>%
  filter(market_type=="Retail"& !is.na(returns1_c))%>%
  group_by(country,market)%>%
  filter(n()>=6)%>% #keep markets with 6 or more market years
  ungroup()%>%
  group_by(country)%>%
 filter(length(unique(market))>=4)%>% #drop 3 countries with only 1 or 2 markets
    ungroup()


split.df=split(presplit,paste(presplit$country,presplit$market))

cm.name=names(split.df)
#results<-list()
table3=data.frame(country_mkt=as.character(),coef=as.numeric())

for (i in 1:length(cm.name)){
df=split.df[[i]]
cname=cm.name[[i]]
m=lm(returns1_c~hmin1,data=df)
#s=summary(m)
#coef=s$coefficients[,1]
#cprep=data.frame(cname,coef)
#table3=rbind(table3,cprep)
p_df=df%>%
  dplyr::select(country,market,cropyear,hmin1,returns1_c)

p_df$p_returns1_c=predict(m,newdata=p_df)

table3=rbind(table3,p_df)

}


######Returns by country (dotplot) vs prediction


#returns to main season
p_risk1=table3

ex_price=p_risk1%>%
  arrange(country,market)%>%
  group_by(country,market)%>%
  dplyr::mutate_at("p_returns1_c",funs(e.preturn=mean,v2.preturn=pvar))%>%
  ungroup()

ex_price_c=ex_price%>%
  group_by(country)%>%
dplyr::summarise(n_mkt=length(unique(market)))

#create sequence of risk aversion coefficients 
sim_rr=seq(0,5,by=0.1)

#create certainty equivalent by risk aversion coefficient and evaluate storage choice
sim=expand_grid(ex_price,sim_rr)%>%
  mutate(cr=e.preturn-((sim_rr*v2.preturn)/2))%>%
  mutate(nostore.r0=if_else(cr<=0,1,0))%>%
  dplyr::mutate(bin=cut(sim_rr,breaks=c(0,1,3,5),right=FALSE,labels=c("Risk Neutral R=[0,1)", "Risk Averse R=[1,3)","High Risk Aversion R=[3,5)")))



#calculate market averages for storage avoidance by risk coefficient
sim_mkt=sim%>%
   group_by(country,market,sim_rr)%>%
  dplyr::summarise(across(contains("nostore."),mean,na.rm=TRUE,.names = "{.col}_mkt"))%>%
  ungroup()

  
#calculate country averages over market averages for storage avoidance by risk coefficients and aggregate by risk tolerance group
sim_country=sim_mkt%>%
   group_by(country,sim_rr)%>%
  dplyr::summarise(across(contains("nostore."),mean,na.rm=TRUE,.names = "{.col}_c"))%>%
  ungroup()%>%
  mutate(bin=cut(sim_rr,breaks=c(0,1,3,5),right=FALSE,labels=c("Risk Neutral R=[0,1)", "Risk Averse R=[1,3)","High Risk Aversion R=[3,5)")))%>%
  filter(!is.na(bin))%>%
  group_by(country,bin)%>%
   dplyr::summarise(across(contains("nostore."),mean,na.rm=TRUE))%>%
  ungroup()%>%
 pivot_wider(names_from =bin,values_from=c("nostore.r0_mkt_c"))


#calculate total rows and add to dataframes
sim_tot=sim_country%>%
  dplyr::summarise(across(where(is.numeric),mean,na.rm=TRUE))%>%
  mutate(country="Total")%>%
  dplyr::select(country,everything())
 
sim_country=rbind(sim_country,sim_tot)%>%
   dplyr::mutate(across(2:4,~paste0(sprintf("%.1f",.*100),"%")))%>%
  left_join(ex_price_c,by=c("country"))


#separate the data frames by analysis
#storage uptake percent by risk tolerance group (no credit/interest rate)
nostore_r0=sim_country%>%
  dplyr::select(country,n_mkt,everything())


table_grp=xtable(sim_country,auto=TRUE,type="latex")
print(table_grp,file=paste0("c:/Users/lilac2/Box/GIEWS_Project/GIEWS/Final/Output/nostore_pred",format(Sys.Date(),"%d_%m_%y"),".tex"),include.rownames=FALSE)


# risk_facet_pct=ggplot()+
#   geom_bar(data=sim_country,aes(x=rr,y=nostore_mkt_c),stat="identity",color="gray")+
#  #scale_fill_manual(values=c("red","gray"),breaks=c("no storage","store"),labels=c("No storage","Storage"),name="Choice")+
#   #scale_color_manual(values=c("red","gray"),breaks=c("no storage","store"),labels=c("No storage","Storage"),name="Choice")+
#   scale_y_continuous(name="Storage Avoidance (%)",limits=c(0,100),breaks=seq(0,100,25),expand=c(0,0))+
#   scale_x_continuous(name="Relative Risk Aversion Coeffient",limits=c(0,5),expand=c(0,0))+
#   facet_wrap(.~country,scales="free_y",ncol=4)+labs(title="Storage Avoidance by Risk Aversion Coefficient")+
#   theme(panel.grid.minor = element_blank(),panel.background = element_blank(),panel.grid.major = element_blank(),
#          axis.line = element_line(color="black"), strip.background = element_rect(color="black",fill="white"),
#          legend.position = c(0.9, 0),legend.justification = c(1, 0),
#         plot.title = element_text(hjust = 0.5,face="bold"),
#         panel.margin = unit(1,"line"),text= element_text(family="serif"))
# ggsave("C:/Users/lilac2/Box/GIEWS_Project/GIEWS/Graphs/riskcoef_facet.PNG",width=12,height=9)


rm(ex_price,m,p_df,p_risk1,table_grp,table3,i,rr,cname,country.name,split.df,nostore_0,df,extreme1)
rm(list=ls(pattern="sim"))


```



Appendix

A1.Box and dotplots for intratemporal returns
```{r durationA1,echo=FALSE}

setwd("C:/Users/lilac2/Box/GIEWS_Project/GIEWS/Final/Output")

dur1=subset(duration1,is.finite(returns1)&market_type=="Retail"&!country=="Nigeria")

######Returns to duration by country (dotplot)
f_grid_dur_dot=ggplot()+geom_jitter(data=dur1,aes(x=factor(duration1),y=returns1*100,color=factor(noarb1)),size=1)+scale_y_continuous(name="Returns to storage (%)", limits=c(-100,400),breaks=seq(-100,400,100))+xlab("Number of Months Post-Harvest")+
  scale_color_manual(name="Returns",breaks=c("0","1"),values=c("red","black"),labels=c("Negative Returns","Positive Returns"))+
  facet_wrap(.~country,ncol=4,scale="free_x")+labs(title="Intratemporal returns to storage")+theme(legend.position = c(0.9, 0),legend.justification = c(1, 0),plot.title = element_text(hjust = 0.5,face="bold"))

#print(f_grid_dur_dot)
ggsave("dur_returns_facet_dot.PNG",width=12,height=9)

######Returns to duration by country (boxplot)
f_grid_dur_box=ggplot()+geom_boxplot(data=dur1,aes(x=factor(duration1),y=returns1*100),outlier.shape=1,position="dodge")+scale_y_continuous(name="Returns to storage (%)", limits=c(-100,400),breaks=seq(-100,400,100))+xlab("Number of Months Post-Harvest")+geom_hline(yintercept=0,color="red",position="identity")+
  facet_wrap(.~country,ncol=4)+
  #labs(title="Intratemporal returns to storage (primary maize season)")+
  theme(legend.position = c(0.9, 0),legend.justification = c(1, 0),plot.title = element_text(hjust = 0.5,face="bold"))

print(f_grid_dur_box)
ggsave("dur_returns_facet_box.PNG",width=12,height=9)

rm(f_grid_dur_dot,f_grid_dur_box)

```



A2. Malawi Case Study
```{r zambiaA2,echo=FALSE}

setwd("C:/Users/lilac2/Box/GIEWS_Project/GIEWS/Final/Output")

#Retail Price Trend Tables
malawi_mkt6=season%>%
  filter(country=="Malawi"&market_type=="Retail")%>%
   group_by(country,region,market)%>%
  filter(n()>6)

mlist=unique(malawi_mkt6$market)
  
pctp=function(x){
  y=mean(x[x>0],na.rm=TRUE)
}

pctn=function(x){
  y=mean(x[x<=0],na.rm=TRUE)
}

#Seasonal returns (market level)
malawi_mkt=malawi_mkt6%>%
   group_by(country,region,market)%>%
  filter(n()>4)%>%
   dplyr::summarise(across(starts_with("returns1_c"),list(e=mean,pos=~pctp(.x),neg=~pctn(.x)),na.rm=TRUE,.names = "{.fn}.{.col}"),
                    across(starts_with("noarb1_c"),~sum(.x,na.rm=TRUE),.names = "n_season_{.col}"),
                   n.yrs1=length(market[is.finite(returns1_c)]))%>%
       ungroup()%>%
   mutate(pct_season1_c=n_season_noarb1_c/n.yrs1)%>%
  dplyr::select(region,market,n.yrs1,pct_season1_c,e.returns1_c,pos.returns1_c,neg.returns1_c)%>%
dplyr::mutate(across(contains("pct"),~paste0(sprintf("%.1f",.*100),"%")),across(contains("returns"),~paste0(sprintf("%.1f",.*100),"%")))

print=xtable(malawi_mkt,type="latex")
names(print)<-c("Region","Market","Market-Years","Frequency of Negative Returns",
                "Average Total Returns","Average Positive Returns","Average Negative Returns")
print(print,file=paste0("c:/Users/lilac2/Box/GIEWS_Project/GIEWS/Final/Output/malawi_mkts",format(Sys.Date(),"%d_%m_%y"),".tex"),include.rownames=FALSE)


#minmax and monthly average
#malawi planting is sept/oct and harvest is april/may

malawi_monavg = returns_dur%>%
  filter(country=="Malawi"&market%in%mlist&market_type=="Retail")%>%
  group_by(country,market,commodity,month) %>%
  dplyr::summarise(month_avg_real=mean(price_real,na.rm=TRUE))

malawi_plot_avg=ggplot(data=malawi_monavg)+
       geom_rect(aes(xmin=9,xmax=11,ymin=-Inf,ymax=Inf,fill="gray90"),
                 color="black",alpha=0.5,show.legend=FALSE)+
       geom_rect(aes(xmin=4,xmax=6,ymin=-Inf,ymax=Inf,fill="grey50"),
                 color="black",alpha=0.5,show.legend=FALSE)+
      scale_fill_manual(values=c("gray90","grey50"))+
  geom_text(aes(x=10.7,y=0,label="Planting"),size=3)+
    geom_text(aes(x=4.7,y=0,label="Harvest"),size=3)+
  new_scale_fill()+
      geom_line(aes(x=month,y=month_avg_real,group=market,color=market),show.legend=FALSE)+
          labs(x="Month",y="Mean Value of Maize per Kilo (2015 Local Currency)") +
    scale_x_discrete(name="Month",limits=c("1","2","3","4","5","6","7","8","9","10","11","12"),expand=c(0,0))+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(),panel.background = element_blank(),axis.line = element_line(color="black"))+ ggtitle("Malawi Retail markets (10+ years of data)")
  
print(malawi_plot_avg)
ggsave("malawi_plot_avg.PNG",width=12,height=9)

malawi_minmax=returns_dur%>%
   filter(country=="Malawi"&market%in%mlist&market_type=="Retail")%>%
  dplyr::group_by(country,market,commodity,year)%>%
  filter(!is.na(price_real))%>%
  dplyr::summarise(min_price=min(price_real),max_price=max(price_real),
                   min_month=month[which.min(price_real)],max_month=month[which.max(price_real)])%>%
  pivot_longer(cols=min_price:max_month,names_to=c("variable",".value"),names_sep="_",values_drop_na=TRUE)


malawi_plot_minmax=ggplot(data=malawi_minmax)+
      geom_rect(aes(xmin=9,xmax=11,ymin=-Inf,ymax=Inf,fill="gray90"),
                 color="black",alpha=0.5,show.legend=FALSE)+
       geom_rect(aes(xmin=4,xmax=6,ymin=-Inf,ymax=Inf,fill="grey50"),
                 color="black",alpha=0.5,show.legend=FALSE)+
      scale_fill_manual(values=c("gray90","grey50"))+
  geom_text(aes(x=10.7,y=0,label="Planting"),size=3)+
    geom_text(aes(x=4.7,y=0,label="Harvest"),size=3)+
  new_scale_fill()+
  geom_histogram(aes(x=month,fill=variable,color=variable),binwidth=0.5,position="dodge") +
 scale_color_manual(name="Month Type",values=c("turquoise","navyblue"),breaks=c("min","max"),labels=c("Min price","Max price"))+
scale_fill_manual(name="Month Type",values=c("turquoise","navyblue"),breaks=c("min","max"),labels=c("Min price","Max price"))+
  scale_x_discrete(name="Month",limits=c("1","2","3","4","5","6","7","8","9","10","11","12"),expand=c(0,0)) + 
   ylab("Number of Months")+
   #scale_y_continuous(name="Number of Months",limits=c(0,max(count(m$month))))+
   theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(),
         panel.background = element_blank(),axis.line = element_line(color="black"))+
  ggtitle(paste("Malawi Maize Retail Market Prices (Primary Season)"))

print(malawi_plot_minmax)
ggsave("malawi_plot_minmax.PNG",width=12,height=9)


#CE analysis by market for Malawi

#returns to main season
ex_price=malawi_mkt6%>%
  mutate(return=returns1_c,pl=pmax1,ph=hmin1)%>%
  arrange(market)%>%
  group_by(market)%>%
  dplyr::mutate(across(c(ph,pl,return),list(e=mean,v=var,v2=~pvar(.x)),na.rm=TRUE,.names = "{.fn}.{.col}"))%>%
  ungroup()%>%
  dplyr::select(1:6,e.pl,ph,v.pl,return,e.return,v.return,v2.return)


#create sequence of risk aversion coefficients between 0 and 5 
sim_rr=seq(0,5,by=0.1)

#create certainty equivalent based on risk aversion coefficients and evaluate storage choice by comparing CE to harvest price and group by risk aversion tolerance with and without credit access (5% interest), also calculate the minimum risk coefficient to opt out of storage
sim=expand_grid(ex_price,sim_rr)%>%
  mutate(ce=e.pl-((sim_rr*v.pl)/(2*e.pl)),cr=e.return-((sim_rr*v2.return)/2))%>%
  mutate(nostore.0=if_else(ph>ce,1,0),nostore.r0=if_else(cr<=0,1,0))%>%
  dplyr::mutate(bin=cut(sim_rr,breaks=c(0,1,3,5),right=FALSE,labels=c("Risk Neutral R=[0,1)", "Risk Averse R=[1,3)","High Risk Aversion R=[3,5)")))


#calculate country averages over all observations for storage avoidance by risk coefficients and aggregate by risk tolerance group
sim_mkt_all=sim%>%
   group_by(region,market,sim_rr)%>%
   dplyr::summarise(across(contains("nostore."),mean,na.rm=TRUE,.names = "{.col}_c"))%>%
   ungroup()%>%
  mutate(bin=cut(sim_rr,breaks=c(0,1,3,5),right=FALSE,labels=c("Risk Neutral R=[0,1)", "Risk Averse R=[1,3)","High Risk Aversion R=[3,5)")))%>%
  filter(!is.na(bin))%>%
  group_by(region,market,bin)%>%
   dplyr::summarise(across(contains("nostore."),mean,na.rm=TRUE))%>%
  ungroup()%>%
 pivot_wider(names_from =bin,values_from=c("nostore.0_c","nostore.r0_c"))%>%
  dplyr::mutate(across(3:5,~paste0(sprintf("%.1f",.*100),"%")))

sim_mkt_r=sim_mkt_all%>%
  dplyr::select(1,2,starts_with("nostore.r0"))

sim_table_grp=xtable(sim_mkt_all,auto=TRUE,type="latex")
print(sim_table_grp,file=paste0("./Malawi_riskgrp_",format(Sys.Date(),"%d_%m_%y"),".tex"),include.rownames=FALSE)




rm(list=ls(pattern="sim"),pctn,pctp,mlist,print)
rm(list=ls(pattern="malawi"))


```

